{% extends "style/base_public.html" %}
{% load static %}

{% block title %}Detalhe - Item #{{ item.pk }}{% endblock %}

{% block body %}
<section class="card" style="max-width:900px;margin:16px auto;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h2>Detalhe da Venda â€” Pedido #{{ item.pedido.pk }}</h2>
      <div class="muted">Produto: {{ item.produto.nome }} Â· Quantidade: {{ item.quantidade }}</div>
    </div>
    <div>
      <a class="btn" href="{% url 'amigofiel:painel-empresa-fluxo' handle=empresa.user.username %}">â† Voltar</a>
    </div>
  </div>

  <hr style="margin:12px 0;">

  <div style="display:flex; gap:20px; align-items:flex-start;">
    <div style="width:160px; height:160px; border:1px solid #eee; display:flex; align-items:center; justify-content:center;">
      {% if item.produto.imagem %}
        <img src="{{ item.produto.imagem.url }}" alt="{{ item.produto.nome }}" style="max-height:150px; max-width:150px; object-fit:contain;">
      {% else %}
        <div style="color:#999; font-size:0.9rem;">Sem imagem</div>
      {% endif %}
    </div>

    <div style="flex:1;">
      <h3 style="margin:0 0 8px 0;">{{ item.produto.nome }}</h3>
      <div>Pedido: #{{ item.pedido.pk }} â€” <small>{{ item.pedido.criado_em|date:"Y-m-d H:i" }}</small></div>
      <div>Cliente: {{ cliente.username }}{% if cliente.email %} Â· {{ cliente.email }}{% endif %}</div>

      <div style="margin-top:12px;">
        <div>Quantidade: <strong>{{ item.quantidade }}</strong></div>
        <div>PreÃ§o unitÃ¡rio: R$ {{ item.preco_unitario|floatformat:2 }}</div>
        <div style="font-weight:700; margin-top:8px;">Total item: R$ {{ item.total|floatformat:2 }}</div>
        {% if item.percentual_doacao %}
          <div style="color:#2d6a4f;">DoaÃ§Ã£o: {{ item.percentual_doacao }}% â†’ R$ {{ item.valor_doacao|floatformat:2 }}</div>
        {% endif %}
      </div>

      <div style="margin-top:18px; display:flex; gap:8px; align-items:center;">
        <a class="btn" href="{% url 'amigofiel:item-recibo' item.pk %}" target="_blank">ğŸ–¨ï¸ Imprimir recibo</a>
        <button id="toggleRetirado" class="btn" data-item-id="{{ item.pk }}">{% if item.retirado %}Marcar como pendente{% else %}Confirmar retirada{% endif %}</button>
        <span id="statusBadge" style="font-weight:700; margin-left:12px;">{% if item.retirado %}<span style="color:green;">Entregue</span>{% else %}<span style="color:#c2410c;">Pendente</span>{% endif %}</span>
      </div>

    </div>
  </div>

  {% if ong %}
    <hr style="margin:12px 0;">
    <div>
      <h4>ONG beneficiada</h4>
      <div>{{ ong.nome_fantasia }} â€” CNPJ: {{ ong.cnpj }}</div>
    </div>
  {% endif %}

  <script>
    (function(){
      function getCookie(name) { const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return v ? v.pop() : ''; }
      const csrftoken = getCookie('csrftoken');
      const btn = document.getElementById('toggleRetirado');
      const status = document.getElementById('statusBadge');
      if (!btn) return;
      btn.addEventListener('click', function(){
        const itemId = Number(btn.dataset.itemId || 0);
        if (!itemId) { alert('Item invÃ¡lido'); return; }
        btn.disabled = true;
        fetch("{% url 'amigofiel:item-toggle-retirado' %}", {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify({ item_id: itemId })
        }).then(r => r.json()).then(data => {
          if (data && data.success) {
            if (data.retirado) {
              btn.textContent = 'Marcar como pendente';
              status.innerHTML = '<span style="color:green;">Entregue</span>';
            } else {
              btn.textContent = 'Confirmar retirada';
              status.innerHTML = '<span style="color:#c2410c;">Pendente</span>';
            }
          } else {
            alert('Falha ao alterar status.');
          }
        }).catch(()=> alert('Erro na requisiÃ§Ã£o')).finally(()=> btn.disabled = false);
      });
    })();
  </script>

</section>
{% endblock %}
