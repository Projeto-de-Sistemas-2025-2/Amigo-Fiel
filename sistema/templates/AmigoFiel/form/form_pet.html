{% extends "style/base_public.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Cadastrar{% endif %} Pet - Amigo Fiel{% endblock %}

{% block body %}
<section class="card" style="max-width:900px;margin:2rem auto">
  <div style="margin-bottom:2rem">
    <h1 style="margin-bottom:0.5rem">
      {% if form.instance.pk %}
        ‚úèÔ∏è Editar Informa√ß√µes do Pet
      {% else %}
        üêæ Cadastrar Pet para Ado√ß√£o
      {% endif %}
    </h1>
    <p class="muted">Preencha as informa√ß√µes sobre o pet que est√° dispon√≠vel para ado√ß√£o</p>
  </div>

  <form method="post" enctype="multipart/form-data" class="grid grid-1" style="gap:1.5rem" novalidate>
    {% csrf_token %}

    <!-- Informa√ß√µes B√°sicas -->
    <fieldset style="border:1px solid #e0e0e0;padding:1.5rem;border-radius:8px">
      <legend style="font-weight:600;padding:0 0.5rem">üêæ Identifica√ß√£o</legend>
      
      <div class="grid grid-1" style="gap:1rem">
        <div class="grid grid-1 grid-md-2" style="gap:1rem">
          <div class="input-wrap">
            <label for="{{ form.nome.id_for_label }}">{{ form.nome.label }} <span style="color:red">*</span></label>
            {{ form.nome }}
            {% if form.nome.help_text %}
              <small class="muted" style="font-size:0.875rem">{{ form.nome.help_text }}</small>
            {% endif %}
            {% if form.nome.errors %}
              <span class="error-text" style="color:red;font-size:0.875rem">{{ form.nome.errors }}</span>
            {% endif %}
          </div>

          <div class="input-wrap">
            <label for="{{ form.especie.id_for_label }}">{{ form.especie.label }} <span style="color:red">*</span></label>
            {{ form.especie }}
            {% if form.especie.errors %}
              <span class="error-text" style="color:red;font-size:0.875rem">{{ form.especie.errors }}</span>
            {% endif %}
          </div>
        </div>

        <div class="grid grid-1 grid-md-3" style="gap:1rem">
          <div class="input-wrap">
            <label for="{{ form.raca.id_for_label }}">{{ form.raca.label }}</label>
            {{ form.raca }}
            {% if form.raca.help_text %}
              <small class="muted" style="font-size:0.875rem">{{ form.raca.help_text }}</small>
            {% endif %}
            {% if form.raca.errors %}
              <span class="error-text" style="color:red;font-size:0.875rem">{{ form.raca.errors }}</span>
            {% endif %}
          </div>

          <div class="input-wrap">
            <label for="{{ form.idade_anos.id_for_label }}">{{ form.idade_anos.label }} <span style="color:red">*</span></label>
            {{ form.idade_anos }}
            {% if form.idade_anos.help_text %}
              <small class="muted" style="font-size:0.875rem">{{ form.idade_anos.help_text }}</small>
            {% endif %}
            {% if form.idade_anos.errors %}
              <span class="error-text" style="color:red;font-size:0.875rem">{{ form.idade_anos.errors }}</span>
            {% endif %}
          </div>

          <div class="input-wrap">
            <label for="{{ form.sexo.id_for_label }}">{{ form.sexo.label }}</label>
            {{ form.sexo }}
            {% if form.sexo.errors %}
              <span class="error-text" style="color:red;font-size:0.875rem">{{ form.sexo.errors }}</span>
            {% endif %}
          </div>
        </div>
      </div>
    </fieldset>

    <!-- Sa√∫de -->
    <fieldset style="border:1px solid #e0e0e0;padding:1.5rem;border-radius:8px">
      <legend style="font-weight:600;padding:0 0.5rem">üíâ Sa√∫de e Cuidados</legend>
      
      <div class="grid grid-1 grid-md-2" style="gap:1.5rem">
        <div class="input-wrap" style="display:flex;gap:0.75rem;align-items:flex-start;padding:1rem;background:#f9fafb;border-radius:6px">
          {{ form.castrado }}
          <div style="flex:1">
            <label for="{{ form.castrado.id_for_label }}" style="margin:0;font-weight:500">{{ form.castrado.label }}</label>
            {% if form.castrado.help_text %}
              <p class="small muted" style="margin:0.25rem 0 0 0">{{ form.castrado.help_text }}</p>
            {% endif %}
          </div>
          {% if form.castrado.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.castrado.errors }}</span>
          {% endif %}
        </div>

        <div class="input-wrap" style="display:flex;gap:0.75rem;align-items:flex-start;padding:1rem;background:#f9fafb;border-radius:6px">
          {{ form.vacinado }}
          <div style="flex:1">
            <label for="{{ form.vacinado.id_for_label }}" style="margin:0;font-weight:500">{{ form.vacinado.label }}</label>
            {% if form.vacinado.help_text %}
              <p class="small muted" style="margin:0.25rem 0 0 0">{{ form.vacinado.help_text }}</p>
            {% endif %}
          </div>
          {% if form.vacinado.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.vacinado.errors }}</span>
          {% endif %}
        </div>
      </div>
    </fieldset>

    <!-- Descri√ß√£o -->
    <fieldset style="border:1px solid #e0e0e0;padding:1.5rem;border-radius:8px">
      <legend style="font-weight:600;padding:0 0.5rem">üìù Sobre o Pet</legend>
      
      <div class="input-wrap">
        <label for="{{ form.descricao.id_for_label }}">{{ form.descricao.label }}</label>
        {{ form.descricao }}
        {% if form.descricao.help_text %}
          <small class="muted" style="font-size:0.875rem">{{ form.descricao.help_text }}</small>
        {% endif %}
        {% if form.descricao.errors %}
          <span class="error-text" style="color:red;font-size:0.875rem">{{ form.descricao.errors }}</span>
        {% endif %}
      </div>
    </fieldset>

    <!-- Foto -->
    <fieldset style="border:1px solid #e0e0e0;padding:1.5rem;border-radius:8px">
      <legend style="font-weight:600;padding:0 0.5rem">üì∏ Foto do Pet</legend>
      
      <div class="grid grid-1 grid-md-2" style="gap:1.5rem;align-items:start">
        <div class="input-wrap">
          <label for="{{ form.imagem.id_for_label }}">{{ form.imagem.label }}</label>
          {% if form.instance.imagem %}
            <div style="margin-bottom:0.5rem">
              <img src="{{ form.instance.imagem.url }}" alt="Foto atual" 
                   style="max-width:100%;max-height:300px;border-radius:8px;border:1px solid #e0e0e0">
              <p class="small muted" style="margin-top:0.5rem">Foto atual do pet</p>
            </div>
          {% endif %}
          {{ form.imagem }}
          <small class="muted" style="font-size:0.875rem">Formatos aceitos: JPG, PNG, GIF (m√°x. 5MB)</small>
          {% if form.imagem.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.imagem.errors }}</span>
          {% endif %}
        </div>

        <div style="text-align:center">
          <label style="display:block;margin-bottom:0.75rem;font-weight:500">Pr√©-visualiza√ß√£o</label>
          <img id="pet-image-preview" 
               src="{% if form.instance.imagem %}{{ form.instance.imagem.url }}{% else %}{% static 'defaults/pet.png' %}{% endif %}" 
               alt="Pr√©-visualiza√ß√£o" 
               style="width:100%;max-width:280px;height:280px;object-fit:cover;border-radius:12px;border:2px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
          <p class="muted small" style="margin-top:0.75rem" id="preview-label">
            {% if form.instance.imagem %}Foto atual{% else %}Aguardando foto...{% endif %}
          </p>
        </div>
      </div>
    </fieldset>

    <!-- Bot√µes de A√ß√£o -->
    <div class="actions" style="display:flex;gap:1rem;justify-content:flex-end;padding-top:1rem;border-top:1px solid #e0e0e0">
      <a class="btn btn-ghost" href="{% if user.perfil_ong %}{% url 'amigofiel:painel-ong' handle=user.username %}{% else %}{% url 'amigofiel:listar-animais' %}{% endif %}">
        ‚Üê Cancelar
      </a>
      <button class="btn btn-primary" type="submit">
        {% if form.instance.pk %}
          üíæ Salvar Altera√ß√µes
        {% else %}
          üêæ Cadastrar Pet
        {% endif %}
      </button>
    </div>
  </form>
</section>

<style>
  fieldset {
    margin: 0;
  }
  
  legend {
    font-size: 1rem;
    color: #333;
  }
  
  .input-wrap {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .input-wrap label {
    font-weight: 500;
    color: #333;
  }
  
  .error-text {
    display: block;
    margin-top: 0.25rem;
  }

  #pet-image-preview {
    transition: all 0.3s ease;
  }

  #pet-image-preview:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
</style>

<script>
  (function(){
    // Localiza o input file e preview
    const fileInput = document.querySelector('input[type="file"][name$="imagem"]') || document.querySelector('input[type="file"]');
    const preview = document.getElementById('pet-image-preview');
    const previewLabel = document.getElementById('preview-label');
    
    if (!fileInput || !preview) return;

    fileInput.addEventListener('change', function(e){
      const file = e.target.files && e.target.files[0];
      
      if (!file) {
        // Restaura imagem padr√£o se nenhum arquivo for selecionado
        preview.src = "{% static 'defaults/pet.png' %}";
        if (previewLabel) previewLabel.textContent = "Aguardando foto...";
        return;
      }
      
      // Valida se √© uma imagem
      if (!file.type.startsWith('image/')) {
        alert('‚ö†Ô∏è Por favor, selecione um arquivo de imagem v√°lido (JPG, PNG ou GIF).');
        fileInput.value = '';
        preview.src = "{% static 'defaults/pet.png' %}";
        if (previewLabel) previewLabel.textContent = "Aguardando foto...";
        return;
      }
      
      // Valida tamanho (m√°x. 5MB)
      const maxSize = 5 * 1024 * 1024; // 5MB em bytes
      if (file.size > maxSize) {
        alert('‚ö†Ô∏è A imagem √© muito grande! O tamanho m√°ximo √© 5MB.');
        fileInput.value = '';
        return;
      }
      
      // Carrega e exibe a imagem
      const reader = new FileReader();
      reader.onload = function(ev){
        preview.src = ev.target.result;
        if (previewLabel) {
          previewLabel.textContent = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        }
      };
      reader.onerror = function(){
        alert('‚ö†Ô∏è Erro ao carregar a imagem. Tente novamente.');
        fileInput.value = '';
      };
      reader.readAsDataURL(file);
    });
  })();
</script>
{% endblock %}
// ...existing code...