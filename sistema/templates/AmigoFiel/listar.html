{% extends "style/base_public.html" %}
{% load static %}

{% block title %}Pets para adoção — Amigo Fiel{% endblock %}

{% block body %}
<div class="container" style="display:grid;grid-template-columns:260px 1fr;gap:16px;">
  <!-- SIDEBAR / BANNER + FILTROS -->
  <aside class="card" aria-label="CTA e Filtros para adoção" style="position:sticky;top:16px;height:fit-content;">
    <!-- CTA/Banner (1:1) -->
    <div style="display:flex;flex-direction:column;gap:10px;">
      <a href="{% if can_create_pet %}{% url 'amigofiel:pet-novo' %}{% else %}{% url 'login' %}?next={% url 'amigofiel:pet-novo' %}{% endif %}"
         aria-label="Cadastrar um novo pet para adoção"
         style="display:block;">
        <img
          src="{% static 'img/banners/cta_cadastrar_pet.png' %}"
          alt="Anuncie um pet para adoção"
          style="width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;display:block;"
        >
      </a>

      {% if can_create_pet %}
        <a class="btn btn-accent" href="{% url 'amigofiel:pet-novo' %}">Cadastrar novo pet</a>
      {% else %}
        <a class="btn btn-secondary" href="{% url 'login' %}?next={% url 'amigofiel:pet-novo' %}">
          Entrar para cadastrar
        </a>
      {% endif %}
    </div>

    <hr style="margin:12px 0;border:none;height:1px;background:#eee;">

    <!-- Filtros -->
    <form method="get">
      <h2 class="h4" style="margin:0 0 10px;">Refinar busca</h2>

      <!-- Buscar -->
      <div class="input-wrap">
        <label for="q">Pesquisar</label>
        <input id="q" name="q" class="input" type="text" value="{{ q }}" placeholder="Nome ou descrição">
      </div>

      <!-- Espécie -->
      <div class="input-wrap">
        <label for="especie">Espécie</label>
        <select id="especie" name="especie" class="input">
          <option value="">Todas</option>
          {% for v, rot in ESPECIES %}
            <option value="{{ v }}" {% if especie_sel == v %}selected{% endif %}>{{ rot }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Origem -->
      <div class="input-wrap">
        <label for="origem">Origem</label>
        <select id="origem" name="origem" class="input">
          <option value="">ONG ou Independente</option>
          <option value="ong" {% if origem == "ong" %}selected{% endif %}>Apenas ONGs</option>
          <option value="indep" {% if origem == "indep" %}selected{% endif %}>Apenas Independentes</option>
        </select>
      </div>

      <!-- Cidade -->
      <div class="input-wrap">
        <label for="cidade">Cidade</label>
        <input id="cidade" name="cidade" class="input" type="text" value="{{ cidade }}" placeholder="Ex.: Palmas">
      </div>

      <!-- Sexo -->
      <div class="input-wrap">
        <label for="sexo">Sexo</label>
        <select id="sexo" name="sexo" class="input">
          <option value="">Qualquer</option>
          <option value="macho" {% if sexo == "macho" %}selected{% endif %}>Macho</option>
          <option value="femea" {% if sexo == "femea" %}selected{% endif %}>Fêmea</option>
        </select>
      </div>

      <!-- Saúde -->
      <div class="input-wrap" style="display:flex;flex-direction:column;gap:6px;">
        <label style="font-weight:600;">Saúde</label>
        <label style="display:flex;gap:8px;align-items:center;">
          <input type="checkbox" name="castrado" value="1" {% if castrado %}checked{% endif %}>
          <span>Castrado</span>
        </label>
        <label style="display:flex;gap:8px;align-items:center;">
          <input type="checkbox" name="vacinado" value="1" {% if vacinado %}checked{% endif %}>
          <span>Vacinado</span>
        </label>
      </div>

      <!-- Status -->
      <div class="input-wrap" style="display:flex;gap:8px;align-items:center;">
        <input id="adotados" name="adotados" value="1" type="checkbox" {% if adotados %}checked{% endif %}>
        <label for="adotados" style="margin:0">Incluir já adotados</label>
      </div>

      <div class="actions" style="margin-top:10px;display:flex;gap:8px;">
        <button class="btn btn-primary" type="submit">Aplicar filtros</button>
        <a class="btn btn-secondary" href="{% url 'amigofiel:listar-animais' %}">Limpar</a>
      </div>
    </form>
  </aside>

  <!-- MAIN / RESULTADOS -->
  <main>
    <header style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;">
      <h1 class="h3" style="margin:0;">Pets para adoção</h1>
      <span class="muted">
        {% if page_obj %}{{ page_obj.paginator.count }}{% else %}{{ pets|length }}{% endif %}
        resultado{% if page_obj %}{% if page_obj.paginator.count != 1 %}s{% endif %}{% else %}{% if pets|length != 1 %}s{% endif %}{% endif %}
      </span>
    </header>

    {% if pets %}
  <section class="grid-4 pets-grid" style="align-items:stretch;">
        {% for p in pets %}
          <article class="mini-card" style="display:flex;flex-direction:column;position:relative;">
            <!-- Botão de Favoritar Flutuante -->
            {% if user.is_authenticated and user.perfil_comum %}
        <button type="button" 
          class="favoritar-btn{% if p.id in favoritos_pet_ids %} is-favoritado{% endif %}"
          data-pet-slug="{{ p.slug }}"
          data-pet-nome="{{ p.nome }}"
          data-url="{% url 'amigofiel:favoritar-pet' p.slug %}"
          data-favoritado="{% if p.id in favoritos_pet_ids %}true{% else %}false{% endif %}"
          style="position:absolute;top:8px;right:8px;z-index:10;width:40px;height:40px;padding:0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:all 0.2s;"
          title="{% if p.id in favoritos_pet_ids %}Remover dos favoritos{% else %}Adicionar aos favoritos{% endif %}"
          aria-pressed="{% if p.id in favoritos_pet_ids %}true{% else %}false{% endif %}">
                {% if p.id in favoritos_pet_ids %}❤️{% else %}🤍{% endif %}
              </button>
            {% endif %}

            <a
              {% if p.slug %}
                href="{% url 'amigofiel:perfil-pet' handle=p.slug %}"
              {% else %}
                href="{% url 'amigofiel:listar-animais' %}?q={{ p.nome|urlencode }}"
              {% endif %}
              style="text-decoration:none;color:inherit;display:block"
              aria-label="Abrir perfil de {{ p.nome }}"
            >
              <img class="thumb"
                   src="{% if p.imagem %}{{ p.imagem.url }}{% else %}{% static 'img/defaults/pet.png' %}{% endif %}"
                   alt="{{ p.nome }}" loading="lazy" decoding="async">

              <h3 style="margin:8px 0 4px">{{ p.nome }}</h3>

              <p class="muted" style="margin:0 0 6px">
                {{ p.get_especie_display }}
                {% if p.raca %} • {{ p.raca }}{% endif %}
                {% if p.idade_anos %} • {{ p.idade_anos }} ano{{ p.idade_anos|pluralize }}{% endif %}
              </p>

              <p class="muted" style="margin:0 0 6px">
                {% if p.tutor and p.tutor.cidade %}🏙️ {{ p.tutor.cidade }}
                {% elif p.ong and p.ong.cidade %}🏙️ {{ p.ong.cidade }}
                {% endif %}
                {% if p.adotado %} • ✅ Adotado{% else %} • 💛 Disponível{% endif %}
              </p>

              <p class="muted small" style="margin:0 0 10px">
                {% if p.castrado %}✂️ Castrado{% endif %}
                {% if p.castrado and p.vacinado %} • {% endif %}
                {% if p.vacinado %}💉 Vacinado{% endif %}
              </p>
            </a>

            <div class="actions" style="margin-top:auto;">
              {% if p.slug %}
                <a class="btn btn-primary" href="{% url 'amigofiel:perfil-pet' handle=p.slug %}">Ver pet</a>
              {% else %}
                <a class="btn btn-primary" href="{% url 'amigofiel:listar-animais' %}?q={{ p.nome|urlencode }}">Ver pet</a>
              {% endif %}
              {% if p.tutor and p.tutor.cidade %}
                <a class="btn btn-secondary" href="?cidade={{ p.tutor.cidade|urlencode }}"> {{ p.tutor.cidade }} </a>
              {% elif p.ong and p.ong.cidade %}
                <a class="btn btn-secondary" href="?cidade={{ p.ong.cidade|urlencode }}"> {{ p.ong.cidade }} </a>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </section>

      <!-- Paginação -->
      {% if is_paginated %}
        <nav class="actions" aria-label="Paginação" style="margin-top:16px">
          {% if page_obj.has_previous %}
            <a class="btn btn-secondary"
               href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&especie={{ especie_sel|urlencode }}&origem={{ origem|urlencode }}&cidade={{ cidade|urlencode }}&sexo={{ sexo|urlencode }}&castrado={{ castrado }}&vacinado={{ vacinado }}&adotados={{ adotados }}">Anterior</a>
          {% endif %}
          <span class="muted">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a class="btn btn-secondary"
               href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&especie={{ especie_sel|urlencode }}&origem={{ origem|urlencode }}&cidade={{ cidade|urlencode }}&sexo={{ sexo|urlencode }}&castrado={{ castrado }}&vacinado={{ vacinado }}&adotados={{ adotados }}">Próxima</a>
          {% endif %}
        </nav>
      {% endif %}
    {% else %}
      <section class="card center">
        <p class="muted">Nenhum pet encontrado com esses filtros.</p>
      </section>
    {% endif %}
  </main>
</div>

<script>
// Sistema de Favoritar com AJAX
document.querySelectorAll('.favoritar-btn').forEach(btn => {
  const aplicarEstado = (elemento, favoritado) => {
    elemento.dataset.favoritado = favoritado ? 'true' : 'false';
    elemento.textContent = favoritado ? '❤️' : '🤍';
    elemento.setAttribute('aria-pressed', favoritado ? 'true' : 'false');
    elemento.classList.toggle('is-favoritado', favoritado);
    elemento.title = favoritado ? 'Remover dos favoritos' : 'Adicionar aos favoritos';
  };

  aplicarEstado(btn, btn.dataset.favoritado === 'true');

  btn.addEventListener('click', async function(e) {
    e.preventDefault();
    const url = this.dataset.url;
    const petNome = this.dataset.petNome || this.dataset.petSlug;
    
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      const data = await response.json();
      
      if (data.sucesso) {
        // Atualizar cor do botão
        aplicarEstado(this, data.favoritado);

        const mensagem = data.favoritado
          ? `${petNome} adicionado aos favoritos!`
          : `${petNome} removido dos favoritos!`;

        showNotification(mensagem, data.favoritado ? 'success' : 'info');
      }
    } catch (error) {
      console.error('Erro ao favoritar:', error);
      showNotification('Erro ao favoritar. Tente novamente.', 'error');
    }
  });
});

// Função para obter CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Função para mostrar notificação
function showNotification(message, type = 'info') {
  const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
  const notification = document.createElement('div');
  notification.className = `alert ${alertClass} position-fixed top-0 start-50 translate-middle-x mt-3`;
  notification.style.zIndex = '9999';
  notification.textContent = message;
  notification.style.animation = 'fadeInOut 3s ease-in-out';
  
  document.body.appendChild(notification);
  
  setTimeout(() => notification.remove(), 3000);
}

// CSS para animação
const style = document.createElement('style');
style.textContent = `
  .pets-grid .favoritar-btn {
    background: #fff;
    border: 1px solid #ddd;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  .pets-grid .favoritar-btn:hover {
    background: #fff3f3;
    border-color: #ff6b9d;
    transform: translateY(-1px);
  }

  .pets-grid .favoritar-btn.is-favoritado {
    background: #ffe0e6;
    border-color: #ff6b9d;
    box-shadow: 0 6px 16px rgba(255, 107, 157, 0.25);
  }

  .pets-grid .favoritar-btn.is-favoritado:hover {
    background: #ffd2dc;
  }

  .pets-grid .favoritar-btn:focus-visible {
    outline: 2px solid #ff6b9d;
    outline-offset: 2px;
  }

  @keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { opacity: 0; }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}
