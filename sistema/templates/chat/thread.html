{% extends "style/base_public.html" %}
{% load static %}

{% block title %}{{ other_info.name }} ‚Äî Conversa{% endblock %}

{% block body %}
<section class="card" style="display:flex; flex-direction:column; height:70vh; max-width:900px; margin:0 auto;">
  <header style="border-bottom:2px solid #e2e8f0; padding:16px; margin-bottom:12px; display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
    <img src="{{ other_info.avatar_url }}" alt="{{ other_info.name }}" 
         width="48" height="48" 
         style="border-radius:50%;object-fit:cover;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
    <div style="flex:1;">
      <strong style="font-size:18px;">{{ other_info.name }}</strong>
      <div style="font-size:13px;color:#64748b;margin-top:2px;">
        @{{ other.username }}
        {% if other_info.location %} ¬∑ üìç {{ other_info.location }}{% endif %}
        {% if other_info.type == 'empresa' %}
          <span class="badge" style="background:#fef3c7;color:#92400e;font-size:11px;padding:2px 8px;border-radius:999px;font-weight:600;margin-left:6px;">LOJA</span>
        {% elif other_info.type == 'ong' %}
          <span class="badge" style="background:#dcfce7;color:#166534;font-size:11px;padding:2px 8px;border-radius:999px;font-weight:600;margin-left:6px;">ONG</span>
        {% endif %}
      </div>
    </div>
    <a href="{% url 'chat:inbox' %}" class="btn btn-secondary" style="font-size:14px;">‚Üê Voltar</a>
  </header>

  <div id="msgbox" style="flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; padding:12px;">
    {% for m in messages %}
      {% if m.sender_id == user.id %}
        <div style="display:flex; justify-content:flex-end;">
      {% else %}
        <div style="display:flex; justify-content:flex-start;">
      {% endif %}
        {% if m.sender_id == user.id %}
        <div style="max-width:70%; padding:10px 14px; border-radius:16px 16px 4px 16px; background:#3b82f6; color:#fff; box-shadow:0 2px 6px rgba(59,130,246,0.3);">
        {% else %}
        <div style="max-width:70%; padding:10px 14px; border-radius:16px 16px 16px 4px; background:#f1f5f9; color:#000; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
        {% endif %}
          <div style="font-size:12px; opacity:.8; margin-bottom:4px; font-weight:600;">
            {% if m.sender_id != user.id %}{{ m.sender.username }}{% else %}Voc√™{% endif %}
          </div>
          <div style="line-height:1.5;">{{ m.text|linebreaksbr }}</div>
          <div style="font-size:11px; opacity:.6; margin-top:6px; text-align:right;">{{ m.created_at|date:"d/m H:i" }}</div>
        </div>
      </div>
    {% empty %}
      <div style="text-align:center; padding:40px; color:#94a3b8;">
        <div style="font-size:48px; margin-bottom:12px;">üëã</div>
        <p style="font-size:16px; margin:0;">Sem mensagens ainda. Diga um oi!</p>
      </div>
    {% endfor %}
  </div>

  <form method="post" style="display:flex; gap:10px; padding:14px; border-top:2px solid #e2e8f0; background:#f8fafc;">
    {% csrf_token %}
    <input type="text" name="text" class="input" placeholder="Escreva uma mensagem‚Ä¶" required 
           style="flex:1; padding:12px; border-radius:999px; border:2px solid #e2e8f0; font-size:14px;">
    <button type="submit" class="btn btn-primary" style="border-radius:999px; padding:12px 24px;">Enviar</button>
  </form>
</section>

<script>
  // scroll pro fim
  const box = document.getElementById('msgbox');
  box.scrollTop = box.scrollHeight;

  // polling simples (5s)
  let lastISO = "{{ messages.last.created_at|date:'c' }}" || null;
  async function pull() {
    try {
      const url = "{% url 'chat:api-thread-since' username=other.username %}" + (lastISO ? ("?since=" + encodeURIComponent(lastISO)) : "");
      const r = await fetch(url, {headers: {'X-Requested-With': 'fetch'}});
      if (!r.ok) return;
      const data = await r.json();
      if (data.messages && data.messages.length) {
        data.messages.forEach(m => {
          const wrap = document.createElement('div');
          wrap.style.display = 'flex';
          wrap.style.justifyContent = (m.sender === "{{ user.username }}") ? 'flex-end' : 'flex-start';
          const bubble = document.createElement('div');
          bubble.style.maxWidth = '70%';
          bubble.style.padding = '10px 14px';
          const mine = (m.sender === "{{ user.username }}");
          bubble.style.borderRadius = mine ? '16px 16px 4px 16px' : '16px 16px 16px 4px';
          bubble.style.background = mine ? '#3b82f6' : '#f1f5f9';
          bubble.style.color = mine ? '#fff' : '#000';
          bubble.style.boxShadow = mine ? '0 2px 6px rgba(59,130,246,0.3)' : '0 2px 4px rgba(0,0,0,0.05)';
          bubble.innerHTML = `<div style="font-size:12px;opacity:.8;margin-bottom:4px;font-weight:600;">${mine?'Voc√™':m.sender}</div>
                              <div style="line-height:1.5;">${m.text.replace(/\n/g,'<br>')}</div>
                              <div style="font-size:11px;opacity:.6;margin-top:6px;text-align:right;">agora</div>`;
          wrap.appendChild(bubble);
          box.appendChild(wrap);
          box.scrollTop = box.scrollHeight;
          lastISO = m.created_at;
        });
      }
    } catch (e) {console.error('Polling error:', e);}
  }
  setInterval(pull, 5000);
</script>
{% endblock %}
