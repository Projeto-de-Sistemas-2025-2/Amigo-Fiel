{% extends "style/base_public.html" %}
{% load static %}

{% block title %}Painel ‚Äî {{ perfil.nome_fantasia }}{% endblock %}

{% block body %}
<section class="hero-ong">
  <div class="ong-header">
    <img class="ong-avatar" 
         src="{% if perfil.foto %}{{ perfil.foto.url }}{% else %}{% static 'img/defaults/avatar_ong.png' %}{% endif %}"
         alt="{{ perfil.nome_fantasia }}">
    <div class="ong-info">
      <h1>Painel da ONG</h1>
      <p class="muted">
        <strong>{{ perfil.nome_fantasia }}</strong> ¬∑ @{{ perfil.user.username }}
        {% if perfil.cidade %} ¬∑ üèôÔ∏è {{ perfil.cidade }}{% endif %}
      </p>
      {% if perfil.slogan %}
        <p class="slogan">{{ perfil.slogan }}</p>
      {% endif %}
    </div>
  </div>
  <div class="actions" style="margin-top:12px">
    <a class="btn btn-primary" href="{% url 'amigofiel:pet-novo' %}">‚ûï Cadastrar pet</a>
    <a class="btn" href="{% url 'amigofiel:perfil-editar' %}" style="background:#f59e0b;color:white;border-color:#f59e0b;">‚úèÔ∏è Editar Perfil</a>
    <a class="btn btn-secondary" href="{% url 'amigofiel:perfil-ong' handle=perfil.user.username %}">Ver perfil p√∫blico</a>
  </div>
</section>

<section class="metrics-grid">
  <article class="metric-card">
    <div class="metric-icon" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
      üêæ
    </div>
    <div class="metric-content">
      <h3>Pets para Ado√ß√£o</h3>
      <p class="muted">Cadastrados: <strong>{{ qtd_pets }}</strong></p>
      <p class="muted">Aguardando lar: <strong>{{ qtd_pets }}</strong></p>
    </div>
  </article>

  <article class="metric-card">
    <div class="metric-icon" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);">
      üíö
    </div>
    <div class="metric-content">
      <h3>Doa√ß√µes Recebidas</h3>
      <p class="muted">Total arrecadado: <strong style="color:#16a34a;">R$ {{ total_doado|default:"0,00" }}</strong></p>
      <p class="muted">Via produtos solid√°rios</p>
    </div>
  </article>
  
  <article class="metric-card">
    <div class="metric-icon" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
      ü§ù
    </div>
    <div class="metric-content">
      <h3>Parcerias</h3>
      <p class="muted">Empresas parceiras: <strong>{{ total_empresas|default:0 }}</strong></p>
      <p class="muted">Produtos vinculados: <strong>{{ total_produtos_vinculados|default:0 }}</strong></p>
    </div>
  </article>
</section>

{# SE√á√ÉO DE EMPRESAS PARCEIRAS #}
{% if empresas_parceiras %}
<section class="card" style="margin-top:14px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #93c5fd;">
  <div style="display:flex;align-items:center;justify-content:space-between; margin-bottom: 12px;">
    <div style="flex:1;">
      <h2 style="margin:0; display:flex; align-items:center; gap:8px;">
        ü§ù Empresas Parceiras
        <span style="background:#2563eb; color:white; padding:4px 10px; border-radius:999px; font-size:14px; font-weight:800;">
          {{ total_empresas }}
        </span>
      </h2>
      <p class="muted" style="margin:4px 0 0;">{{ total_produtos_vinculados }} produto{{ total_produtos_vinculados|pluralize }} gerando doa√ß√µes para nossa causa!</p>
    </div>
    <button onclick="toggleEmpresasParceiras()" class="btn-toggle-empresas" id="btnToggleEmpresas" type="button">
      <span id="toggleIconEmpresas">‚ñº</span> <span id="toggleTextEmpresas">Retrair</span>
    </button>
  </div>

  <div id="empresasParceirasContent" class="empresas-content">
  {% for parceria in empresas_parceiras %}
    <article class="empresa-parceria-card">
      <div class="empresa-header">
        <img class="empresa-avatar" 
             src="{% if parceria.empresa.foto %}{{ parceria.empresa.foto.url }}{% else %}{% static 'img/defaults/avatar_empresa.png' %}{% endif %}"
             alt="{{ parceria.empresa.razao_social }}">
        <div class="empresa-info">
          <h3 style="margin:0;">
            <a href="{% url 'amigofiel:perfil-empresa' handle=parceria.empresa.user.username %}" 
               style="color:#1e40af; text-decoration:none;">
              {{ parceria.empresa.razao_social }}
            </a>
          </h3>
          <p class="muted" style="margin:2px 0 0; font-size:13px;">
            @{{ parceria.empresa.user.username }}
            {% if parceria.empresa.cidade %} ¬∑ üìç {{ parceria.empresa.cidade }}{% endif %}
          </p>
        </div>
        <span class="produtos-count">{{ parceria.produtos|length }} produto{{ parceria.produtos|length|pluralize }}</span>
      </div>

      <div class="produtos-vinculados">
        {% for prod in parceria.produtos %}
          <div class="produto-vinculo-item">
            <img src="{% if prod.imagem %}{{ prod.imagem.url }}{% else %}{% static 'img/defaults/produto.png' %}{% endif %}"
                 alt="{{ prod.nome }}"
                 class="produto-thumb">
            <div class="produto-info">
              <a href="{% url 'amigofiel:produto-detalhe' empresa_handle=parceria.empresa.user.username produto_slug=prod.slug %}"
                 style="font-weight:600; color:#0f172a; text-decoration:none;">
                {{ prod.nome }}
              </a>
              <div style="display:flex; align-items:center; gap:8px; margin-top:2px;">
                <span style="font-size:13px; color:#64748b;">R$ {{ prod.preco|floatformat:2 }}</span>
                <span class="badge-solidario">{{ prod.percentual_doacao }}% doado</span>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </article>
  {% endfor %}
  </div>
</section>
{% endif %}

{# SE√á√ÉO DE PETS #}
<section class="card" style="margin-top:14px">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <h2>Pets cadastrados</h2>
    <div class="actions" style="display:flex; gap:8px; align-items:center">
      <button onclick="togglePets()" class="btn-toggle-section" id="btnTogglePets" type="button">
        <span id="toggleIconPets">‚ñº</span>
      </button>
      <a class="btn btn-secondary" href="{% url 'amigofiel:listar-animais' %}?ong={{ perfil.user.username }}">Ver todos</a>
      <a class="btn btn-primary" href="{% url 'amigofiel:pet-novo' %}">Novo pet</a>
    </div>
  </div>

  <div id="petsContent" class="pets-content">
  {% if pets %}
    <div class="products-grid">
      {% for pet in pets %}
        <article class="mini-card">
          <img class="thumb" 
               src="{% if pet.imagem %}{{ pet.imagem.url }}{% else %}{% static 'img/defaults/pet.png' %}{% endif %}" 
               alt="{{ pet.nome }}"
               style="height: 200px;">
          <h3>{{ pet.nome }}</h3>
          <p class="muted">{{ pet.get_especie_display }}{% if pet.raca %} ‚Ä¢ {{ pet.raca }}{% endif %}</p>
          <p class="muted small">
            {% if pet.castrado %}‚úÇÔ∏è Castrado{% endif %}
            {% if pet.castrado and pet.vacinado %} ‚Ä¢ {% endif %}
            {% if pet.vacinado %}üíâ Vacinado{% endif %}
          </p>
          <div class="actions">
            {% if pet.slug %}
              <a class="btn btn-primary" href="{% url 'amigofiel:perfil-pet' handle=pet.slug %}">Ver perfil</a>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted" style="margin-top:8px;">Nenhum pet cadastrado.</p>
  {% endif %}
  </div>
</section>
{% endblock %}

{% block extra_js %}
<style>
  /* Hero da ONG com Avatar */
  .hero-ong {
    background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
    border: 1px solid #fde68a;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .ong-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 8px;
  }
  .ong-avatar {
    width: 80px;
    height: 80px;
    border-radius: 16px;
    object-fit: cover;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  .ong-info {
    flex: 1;
  }
  .ong-info h1 {
    margin: 0 0 4px;
    font-size: clamp(20px, 3vw, 28px);
  }
  .ong-info .muted {
    margin: 0;
    font-size: 14px;
  }
  .ong-info .slogan {
    margin: 4px 0 0;
    font-style: italic;
    color: #92400e;
    font-size: 13px;
  }
  
  /* Grid de M√©tricas - 3 colunas */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 14px;
    margin-top: 16px;
  }
  @media (min-width: 768px) {
    .metrics-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  .metric-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
    transition: all 0.2s;
  }
  .metric-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }
  .metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }
  .metric-content {
    flex: 1;
    min-width: 0;
  }
  .metric-content h3 {
    margin: 0 0 8px;
    font-size: 16px;
    color: #0f172a;
  }
  .metric-content p {
    margin: 4px 0;
    font-size: 13px;
  }
  .metric-content p strong {
    color: #0f172a;
    font-size: 15px;
  }

  /* Responsive grid for products/pets */
  .products-grid {
    display: grid;
    gap: 12px;
    margin-top: 10px;
    grid-template-columns: repeat(1, minmax(0, 1fr));
  }
  @media (min-width: 640px) {
    .products-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (min-width: 900px) {
    .products-grid { grid-template-columns: repeat(3, 1fr); }
  }
  @media (min-width: 1200px) {
    .products-grid { grid-template-columns: repeat(4, 1fr); }
  }

  .products-grid .mini-card {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .products-grid .mini-card .thumb {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #eee;
  }
  .products-grid .mini-card h3 {
    margin: 8px 0 4px;
    font-size: 1rem;
  }
  .products-grid .mini-card p.muted {
    margin: 0 0 8px;
  }
  .products-grid .mini-card .actions {
    margin-top: auto;
  }

  /* Empresas Parceiras */
  .empresas-content {
    transition: max-height 0.4s ease, opacity 0.3s ease;
    max-height: 5000px;
    opacity: 1;
    overflow: hidden;
  }
  .empresas-content.collapsed {
    max-height: 0;
    opacity: 0;
    margin-top: 0 !important;
  }
  
  /* Pets */
  .pets-content {
    transition: max-height 0.4s ease, opacity 0.3s ease;
    max-height: 5000px;
    opacity: 1;
    overflow: hidden;
    margin-top: 10px;
  }
  .pets-content.collapsed {
    max-height: 0;
    opacity: 0;
    margin-top: 0 !important;
  }
  
  .btn-toggle-empresas {
    display: flex;
    align-items: center;
    gap: 6px;
    background: white;
    border: 2px solid #93c5fd;
    color: #1e40af;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-toggle-empresas:hover {
    background: #eff6ff;
    border-color: #60a5fa;
    transform: translateY(-1px);
  }
  .btn-toggle-empresas #toggleIconEmpresas {
    font-size: 12px;
    transition: transform 0.3s ease;
  }
  .btn-toggle-empresas.collapsed #toggleIconEmpresas {
    transform: rotate(-90deg);
  }
  
  .btn-toggle-section {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: white;
    border: 1px solid #e2e8f0;
    color: #64748b;
    padding: 0;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-toggle-section:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
  }
  .btn-toggle-section #toggleIconPets {
    font-size: 12px;
    transition: transform 0.3s ease;
  }
  .btn-toggle-section.collapsed #toggleIconPets {
    transform: rotate(-90deg);
  }
  
  .empresa-parceria-card {
    background: white;
    border: 1px solid #bfdbfe;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .empresa-parceria-card:last-child {
    margin-bottom: 0;
  }
  .empresa-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #dbeafe;
  }
  .empresa-avatar {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid #93c5fd;
  }
  .empresa-info {
    flex: 1;
  }
  .produtos-count {
    background: #dbeafe;
    color: #1e40af;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 700;
  }
  .produtos-vinculados {
    display: grid;
    gap: 10px;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  }
  .produto-vinculo-item {
    display: flex;
    gap: 10px;
    align-items: center;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px;
    transition: all 0.2s;
  }
  .produto-vinculo-item:hover {
    border-color: #93c5fd;
    box-shadow: 0 2px 8px rgba(147, 197, 253, 0.3);
  }
  .produto-thumb {
    width: 56px;
    height: 56px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
  }
  .produto-info {
    flex: 1;
    min-width: 0;
  }
  .produto-info a {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .produto-info a:hover {
    color: #2563eb;
  }
  .badge-solidario {
    background: #dcfce7;
    color: #15803d;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    white-space: nowrap;
  }
</style>

<script>
  function toggleEmpresasParceiras() {
    const content = document.getElementById('empresasParceirasContent');
    const btn = document.getElementById('btnToggleEmpresas');
    const icon = document.getElementById('toggleIconEmpresas');
    const text = document.getElementById('toggleTextEmpresas');
    
    if (content.classList.contains('collapsed')) {
      content.classList.remove('collapsed');
      btn.classList.remove('collapsed');
      icon.textContent = '‚ñº';
      text.textContent = 'Retrair';
      localStorage.setItem('empresasParceirasExpanded', 'true');
    } else {
      content.classList.add('collapsed');
      btn.classList.add('collapsed');
      icon.textContent = '‚ñ∂';
      text.textContent = 'Expandir';
      localStorage.setItem('empresasParceirasExpanded', 'false');
    }
  }
  
  function togglePets() {
    const content = document.getElementById('petsContent');
    const btn = document.getElementById('btnTogglePets');
    const icon = document.getElementById('toggleIconPets');
    
    if (content.classList.contains('collapsed')) {
      content.classList.remove('collapsed');
      btn.classList.remove('collapsed');
      icon.textContent = '‚ñº';
      localStorage.setItem('petsExpanded', 'true');
    } else {
      content.classList.add('collapsed');
      btn.classList.add('collapsed');
      icon.textContent = '‚ñ∂';
      localStorage.setItem('petsExpanded', 'false');
    }
  }
  
  // Restaurar estado ao carregar a p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    // Empresas Parceiras
    const empresasExpanded = localStorage.getItem('empresasParceirasExpanded');
    if (empresasExpanded === 'false') {
      const content = document.getElementById('empresasParceirasContent');
      const btn = document.getElementById('btnToggleEmpresas');
      const icon = document.getElementById('toggleIconEmpresas');
      const text = document.getElementById('toggleTextEmpresas');
      
      if (content && btn) {
        content.classList.add('collapsed');
        btn.classList.add('collapsed');
        icon.textContent = '‚ñ∂';
        text.textContent = 'Expandir';
      }
    }
    
    // Pets
    const petsExpanded = localStorage.getItem('petsExpanded');
    if (petsExpanded === 'false') {
      const content = document.getElementById('petsContent');
      const btn = document.getElementById('btnTogglePets');
      const icon = document.getElementById('toggleIconPets');
      
      if (content && btn) {
        content.classList.add('collapsed');
        btn.classList.add('collapsed');
        icon.textContent = '‚ñ∂';
      }
    }
  });
</script>
{% endblock %}
