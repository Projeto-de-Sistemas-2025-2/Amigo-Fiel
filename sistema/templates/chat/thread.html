{% extends "style/base_public.html" %}
{% load static %}

{% block title %}@{{ other.username }} â€” Conversa{% endblock %}

{% block body %}
<section class="card" style="display:flex; flex-direction:column; height:70vh;">
  <header style="border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:8px;">
    <strong>Conversando com @{{ other.username }}</strong>
  </header>

  <div id="msgbox" style="flex:1; overflow:auto; display:flex; flex-direction:column; gap:8px;">
    {% for m in messages %}
      {% if m.sender_id == user.id %}
        <div style="display:flex; justify-content:flex-end;">
      {% else %}
        <div style="display:flex; justify-content:flex-start;">
      {% endif %}
        {% if m.sender_id == user.id %}
        <div style="max-width:70%; padding:8px 10px; border-radius:10px; background:#3b82f6; color:#fff;">
        {% else %}
        <div style="max-width:70%; padding:8px 10px; border-radius:10px; background:#f1f5f9; color:#000;">
        {% endif %}
          <div style="font-size:13px; opacity:.9; margin-bottom:2px;">
            {% if m.sender_id != user.id %}@{{ m.sender.username }}{% else %}VocÃª{% endif %}
          </div>
          <div>{{ m.text|linebreaksbr }}</div>
          <div style="font-size:11px; opacity:.7; margin-top:4px;">{{ m.created_at|date:"d/m H:i" }}</div>
        </div>
      </div>
    {% empty %}
      <p class="muted">Sem mensagens ainda. Diga um oi! ðŸ‘‹</p>
    {% endfor %}
  </div>

  <form method="post" style="display:flex; gap:8px; margin-top:8px;">
    {% csrf_token %}
    <input type="text" name="text" class="input" placeholder="Escreva uma mensagemâ€¦" required style="flex:1;">
    <button type="submit" class="btn btn-primary">Enviar</button>
  </form>
</section>

<script>
  // scroll pro fim
  const box = document.getElementById('msgbox');
  box.scrollTop = box.scrollHeight;

  // polling simples (5s). Se nÃ£o quiser, remova este bloco.
  let lastISO = "{{ messages.last.created_at|date:'c' }}" || null;
  async function pull() {
    try {
      const url = "{% url 'chat:api-thread-since' username=other.username %}" + (lastISO ? ("?since=" + encodeURIComponent(lastISO)) : "");
      const r = await fetch(url, {headers: {'X-Requested-With': 'fetch'}});
      if (!r.ok) return;
      const data = await r.json();
      if (data.messages && data.messages.length) {
        data.messages.forEach(m => {
          const wrap = document.createElement('div');
          wrap.style.display = 'flex';
          wrap.style.justifyContent = (m.sender === "{{ user.username }}") ? 'flex-end' : 'flex-start';
          const bubble = document.createElement('div');
          bubble.style.maxWidth = '70%';
          bubble.style.padding = '8px 10px';
          bubble.style.borderRadius = '10px';
          const mine = (m.sender === "{{ user.username }}");
          bubble.style.background = mine ? '#3b82f6' : '#f1f5f9';
          bubble.style.color = mine ? '#fff' : '#000';
          bubble.innerHTML = `<div style="font-size:13px;opacity:.9;margin-bottom:2px;">${mine?'VocÃª':'@'+m.sender}</div>
                              <div>${m.text.replace(/\n/g,'<br>')}</div>
                              <div style="font-size:11px;opacity:.7;margin-top:4px;">agora</div>`;
          wrap.appendChild(bubble);
          box.appendChild(wrap);
          box.scrollTop = box.scrollHeight;
          lastISO = m.created_at;
        });
      }
    } catch (e) {}
  }
  setInterval(pull, 5000);
</script>
{% endblock %}
