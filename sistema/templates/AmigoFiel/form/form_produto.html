{% extends "style/base_public.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Cadastrar{% endif %} Produto - Amigo Fiel{% endblock %}

{% block body %}
<section class="card" style="max-width:900px;margin:2rem auto">
  <div style="margin-bottom:2rem">
    <h1 style="margin-bottom:0.5rem">
      {% if form.instance.pk %}
        ‚úèÔ∏è Editar Produto
      {% else %}
        ‚ûï Cadastrar Novo Produto
      {% endif %}
    </h1>
    <p class="muted">Preencha as informa√ß√µes do produto que ser√° vendido em sua loja</p>
  </div>

  <form method="post" enctype="multipart/form-data" class="grid grid-1" style="gap:1.5rem">
    {% csrf_token %}

    <!-- Informa√ß√µes B√°sicas -->
    <fieldset style="border:1px solid #e0e0e0;padding:1.5rem;border-radius:8px">
      <legend style="font-weight:600;padding:0 0.5rem">üì¶ Informa√ß√µes B√°sicas</legend>
      
      <div class="grid grid-1" style="gap:1rem">
        <div class="input-wrap">
          <label for="{{ form.nome.id_for_label }}">{{ form.nome.label }} <span style="color:red">*</span></label>
          {{ form.nome }}
          {% if form.nome.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.nome.errors }}</span>
          {% endif %}
        </div>

        <div class="input-wrap">
          <label for="{{ form.categoria.id_for_label }}">{{ form.categoria.label }} <span style="color:red">*</span></label>
          {{ form.categoria }}
          {% if form.categoria.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.categoria.errors }}</span>
          {% endif %}
        </div>

        <div class="input-wrap">
          <label for="{{ form.descricao_curta.id_for_label }}">{{ form.descricao_curta.label }}</label>
          {{ form.descricao_curta }}
          {% if form.descricao_curta.help_text %}
            <small class="muted" style="font-size:0.875rem">{{ form.descricao_curta.help_text }}</small>
          {% endif %}
          {% if form.descricao_curta.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.descricao_curta.errors }}</span>
          {% endif %}
        </div>

        <div class="input-wrap">
          <label for="{{ form.descricao.id_for_label }}">{{ form.descricao.label }}</label>
          {{ form.descricao }}
          {% if form.descricao.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.descricao.errors }}</span>
          {% endif %}
        </div>
      </div>
    </fieldset>

    <!-- Pre√ßo e Estoque -->
    <fieldset style="border:1px solid #e0e0e0;padding:1.5rem;border-radius:8px">
      <legend style="font-weight:600;padding:0 0.5rem">üí∞ Pre√ßo e Estoque</legend>
      
      <div class="grid grid-1 grid-md-3" style="gap:1rem">
        <div class="input-wrap">
          <label for="{{ form.preco.id_for_label }}">{{ form.preco.label }} <span style="color:red">*</span></label>
          {{ form.preco }}
          {% if form.preco.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.preco.errors }}</span>
          {% endif %}
        </div>

        <div class="input-wrap">
          <label for="{{ form.desconto_percentual.id_for_label }}">{{ form.desconto_percentual.label }}</label>
          {{ form.desconto_percentual }}
          {% if form.desconto_percentual.help_text %}
            <small class="muted" style="font-size:0.875rem">{{ form.desconto_percentual.help_text }}</small>
          {% endif %}
          {% if form.desconto_percentual.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.desconto_percentual.errors }}</span>
          {% endif %}
        </div>

        <div class="input-wrap">
          <label for="{{ form.estoque.id_for_label }}">{{ form.estoque.label }} <span style="color:red">*</span></label>
          {{ form.estoque }}
          {% if form.estoque.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.estoque.errors }}</span>
          {% endif %}
        </div>
      </div>

      {% if form.instance.preco and form.instance.desconto_percentual > 0 %}
        <div style="margin-top:1rem;padding:1rem;background:#f0f9ff;border-radius:6px">
          <p class="small">
            üí° <strong>Pre√ßo com desconto:</strong> 
            R$ {{ form.instance.preco_com_desconto|floatformat:2 }}
            <span class="muted">(economia de R$ {{ form.instance.valor_desconto|floatformat:2 }})</span>
          </p>
        </div>
      {% endif %}
    </fieldset>

    <!-- V√≠nculo com ONG (Produto Solid√°rio) -->
    <fieldset style="border:1px solid #e0e0e0;padding:1.5rem;border-radius:8px;background:#f0fdf4">
      <legend style="font-weight:600;padding:0 0.5rem">üíö Produto Solid√°rio (Opcional)</legend>
      
      <div style="margin-bottom:1rem;padding:1rem;background:#fff;border-radius:6px;border:1px solid #86efac">
        <p class="small" style="margin:0;color:#166534">
          <strong>üêæ Apoie uma ONG!</strong> Vincule este produto a uma ONG e destine parte do valor das vendas para ajudar animais necessitados.
        </p>
      </div>

      <div class="grid grid-1" style="gap:1rem">
        <div class="input-wrap">
          <label for="{{ form.ong_vinculo.id_for_label }}">{{ form.ong_vinculo.label }}</label>
          {{ form.ong_vinculo }}
          {% if form.ong_vinculo.help_text %}
            <small class="muted" style="font-size:0.875rem">{{ form.ong_vinculo.help_text }}</small>
          {% endif %}
          {% if form.ong_vinculo.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.ong_vinculo.errors }}</span>
          {% endif %}
        </div>

        <div class="grid grid-1 grid-md-2" style="gap:1rem">
          <div class="input-wrap">
            <label for="{{ form.percentual_doacao.id_for_label }}">{{ form.percentual_doacao.label }}</label>
            {{ form.percentual_doacao }}
            {% if form.percentual_doacao.help_text %}
              <small class="muted" style="font-size:0.875rem">{{ form.percentual_doacao.help_text }}</small>
            {% endif %}
            {% if form.percentual_doacao.errors %}
              <span class="error-text" style="color:red;font-size:0.875rem">{{ form.percentual_doacao.errors }}</span>
            {% endif %}
          </div>

          <div class="input-wrap" style="display:flex;gap:0.75rem;align-items:center;padding:1rem;background:#fff;border-radius:6px">
            {{ form.vinculo_ativo }}
            <div>
              <label for="{{ form.vinculo_ativo.id_for_label }}" style="margin:0;font-weight:500">{{ form.vinculo_ativo.label }}</label>
              {% if form.vinculo_ativo.help_text %}
                <p class="small muted" style="margin:0.25rem 0 0 0">{{ form.vinculo_ativo.help_text }}</p>
              {% endif %}
            </div>
            {% if form.vinculo_ativo.errors %}
              <span class="error-text" style="color:red;font-size:0.875rem">{{ form.vinculo_ativo.errors }}</span>
            {% endif %}
          </div>
        </div>

        <div id="doacao-preview" style="display:none;padding:1rem;background:#fff;border-radius:6px;border:1px solid #86efac">
          <p class="small" style="margin:0">
            <strong>Simula√ß√£o:</strong> Com pre√ßo de <span id="preview-preco">R$ 0,00</span> e <span id="preview-percentual">0%</span> de doa√ß√£o, 
            <strong style="color:#166534"><span id="preview-valor">R$ 0,00</span></strong> ser√° destinado √† ONG por venda.
          </p>
        </div>
      </div>
    </fieldset>

    <!-- Imagem e Status -->
    <fieldset style="border:1px solid #e0e0e0;padding:1.5rem;border-radius:8px">
      <legend style="font-weight:600;padding:0 0.5rem">üñºÔ∏è Imagem e Visibilidade</legend>
      
      <div class="grid grid-1" style="gap:1rem">
        <div class="input-wrap">
          <label for="{{ form.imagem.id_for_label }}">{{ form.imagem.label }}</label>
          {% if form.instance.imagem %}
            <div style="margin-bottom:0.5rem">
              <img src="{{ form.instance.imagem.url }}" alt="Imagem atual" 
                   style="max-width:200px;border-radius:8px;border:1px solid #e0e0e0">
              <p class="small muted" style="margin-top:0.5rem">Imagem atual</p>
            </div>
          {% endif %}
          {{ form.imagem }}
          <small class="muted" style="font-size:0.875rem">Formatos aceitos: JPG, PNG, GIF (m√°x. 5MB)</small>
          {% if form.imagem.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.imagem.errors }}</span>
          {% endif %}
        </div>

        <div class="input-wrap" style="display:flex;gap:0.75rem;align-items:center;padding:1rem;background:#f9fafb;border-radius:6px">
          {{ form.ativo }}
          <div>
            <label for="{{ form.ativo.id_for_label }}" style="margin:0;font-weight:500">{{ form.ativo.label }}</label>
            {% if form.ativo.help_text %}
              <p class="small muted" style="margin:0.25rem 0 0 0">{{ form.ativo.help_text }}</p>
            {% endif %}
          </div>
          {% if form.ativo.errors %}
            <span class="error-text" style="color:red;font-size:0.875rem">{{ form.ativo.errors }}</span>
          {% endif %}
        </div>
      </div>
    </fieldset>

    <!-- Bot√µes de A√ß√£o -->
    <div class="actions" style="display:flex;gap:1rem;justify-content:flex-end;padding-top:1rem;border-top:1px solid #e0e0e0">
      <a class="btn btn-ghost" href="{% if user.perfil_empresa %}{% url 'amigofiel:painel-empresa' handle=user.username %}{% else %}{% url 'amigofiel:listar-produtos' %}{% endif %}">
        ‚Üê Cancelar
      </a>
      <button class="btn btn-primary" type="submit">
        {% if form.instance.pk %}
          üíæ Salvar Altera√ß√µes
        {% else %}
          ‚ûï Cadastrar Produto
        {% endif %}
      </button>
    </div>
  </form>
</section>

<style>
  fieldset {
    margin: 0;
  }
  
  legend {
    font-size: 1rem;
    color: #333;
  }
  
  .input-wrap {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .input-wrap label {
    font-weight: 500;
    color: #333;
  }
  
  .error-text {
    display: block;
    margin-top: 0.25rem;
  }
</style>

<script>
  // Simula√ß√£o de doa√ß√£o em tempo real
  (function() {
    const precoInput = document.querySelector('input[name="preco"]');
    const percentualInput = document.querySelector('input[name="percentual_doacao"]');
    const ongSelect = document.querySelector('select[name="ong_vinculo"]');
    const previewDiv = document.getElementById('doacao-preview');
    const previewPreco = document.getElementById('preview-preco');
    const previewPercentual = document.getElementById('preview-percentual');
    const previewValor = document.getElementById('preview-valor');
    
    if (!precoInput || !percentualInput || !previewDiv) return;
    
    function atualizarPreview() {
      const preco = parseFloat(precoInput.value) || 0;
      const percentual = parseFloat(percentualInput.value) || 0;
      const temOng = ongSelect && ongSelect.value;
      
      if (preco > 0 && percentual > 0 && temOng) {
        const valorDoacao = (preco * percentual) / 100;
        previewPreco.textContent = `R$ ${preco.toFixed(2)}`;
        previewPercentual.textContent = `${percentual.toFixed(1)}%`;
        previewValor.textContent = `R$ ${valorDoacao.toFixed(2)}`;
        previewDiv.style.display = 'block';
      } else {
        previewDiv.style.display = 'none';
      }
    }
    
    precoInput.addEventListener('input', atualizarPreview);
    percentualInput.addEventListener('input', atualizarPreview);
    if (ongSelect) {
      ongSelect.addEventListener('change', atualizarPreview);
    }
    
    // Atualiza no carregamento se houver valores
    atualizarPreview();
  })();
</script>
{% endblock %}
