{% extends "style/base_public.html" %}
{% load static %}

{% block title %}{{ produto.nome }} ‚Äî Amigo Fiel{% endblock %}

{% block extra_head %}
<style>
:root{
  --af-bg:#f6f8fb;
  --af-card:#fff;
  --af-border:#e6ebf2;
  --af-text:#0f172a;
  --af-muted:#64748b;
  --af-accent:#0ea5b7;        /* teal/brand */
  --af-accent-600:#0e7490;
  --af-pill:#eef6ff;
  --af-danger:#991b1b;
  --radius:16px;
}

/* layout */
.pd-grid{
  display:grid;
  grid-template-columns: minmax(0,2fr) minmax(320px,1fr);
  gap:18px;
}
@media (max-width:980px){
  .pd-grid{ grid-template-columns:1fr; }
}

.pd-card{background:var(--af-card); border:1px solid var(--af-border); border-radius:var(--radius); padding:16px;}
.pd-hr{height:1px;background:var(--af-border); border:0; margin:12px 0;}

.h1{font-size:clamp(22px,2.6vw,30px); line-height:1.2; margin:0 0 6px; color:var(--af-text);}
.meta{color:var(--af-muted);}
.price{font-size:clamp(24px,2.8vw,32px); font-weight:800; margin:6px 0;}
.old-price{color:var(--af-muted); text-decoration: line-through; font-weight:600;}
.savings{color:#067647; font-weight:600;}
.deal{background:#fff1e6; color:#9a3412;}

/* media (uma √∫nica foto) */
.media-wrap{
  background:linear-gradient(180deg,#fff, var(--af-bg));
  border:1px solid var(--af-border);
  border-radius:var(--radius);
  display:flex; align-items:center; justify-content:center;
  padding:10px; margin-bottom:12px;
}
.media-wrap img{
  width:100%; max-height:560px; aspect-ratio:4/5;
  object-fit:contain;
}

/* chips & badges */
.kv{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
.pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:var(--af-pill); color:#1d4ed8; font-weight:600; font-size:12px;}
.tag{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; background:#f1f5f9; color:#334155; font-size:12px;}
.ok{background:#e6fff4; color:#067647;}
.warn{background:#fee2e2; color:var(--af-danger);}

/* links/ctas em linha */
.inline-actions{display:flex; flex-wrap:wrap; gap:8px;}
.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  border-radius:12px; padding:10px 14px; text-decoration:none; font-weight:600;
  border:1px solid var(--af-border); color:var(--af-text); background:#fff;
}
.btn:hover{box-shadow:0 1px 0 rgba(15,23,42,.06);}
.btn-primary{background:var(--af-accent); border-color:var(--af-accent); color:#fff;}
.btn-primary:hover{background:var(--af-accent-600); border-color:var(--af-accent-600);}
.btn-ghost{background:#fff; border:1px dashed var(--af-border);}

/* buybox */
.buybox{position:sticky; top:16px;}
.buybox .row{display:flex; justify-content:space-between; gap:10px; margin:6px 0;}
.buybox .muted{color:var(--af-muted);}

.qty{
  display:grid; grid-template-columns:40px 1fr 40px; gap:6px; align-items:center;
}
.qty input{
  height:42px; border:1px solid var(--af-border); border-radius:12px; text-align:center;
}
.qty button{
  height:42px; border-radius:12px; border:1px solid var(--af-border); background:#fff; font-weight:700;
}

.btn-lg{width:100%; padding:12px 14px; border-radius:12px; font-weight:800;}
.note{font-size:12px; color:var(--af-muted);}
</style>
{% endblock %}

{% block body %}
<div class="container pd-grid">

  {# ===== COLUNA PRINCIPAL ===== #}
  <section class="pd-card">
    <div class="media-wrap">
      <img src="{% if produto.imagem %}{{ produto.imagem.url }}{% else %}{% static 'img/defaults/produto.png' %}{% endif %}"
           alt="{{ produto.nome }}">
    </div>

    <h1 class="h1">{{ produto.nome }}</h1>

    {% if produto.descricao_curta %}
      <p class="meta" style="margin:0 0 8px;">{{ produto.descricao_curta }}</p>
    {% endif %}

    <div class="kv">
      <span class="meta">
        Loja:
        <a class="accent" href="{% url 'amigofiel:perfil-empresa' handle=produto.empresa.user.username %}">
          {{ produto.empresa.razao_social }}
        </a>
      </span>

      {% if produto.empresa.cidade %}
        <span class="tag">üèôÔ∏è {{ produto.empresa.cidade }}</span>
      {% endif %}

      <span class="tag">üè∑Ô∏è {{ produto.get_categoria_display }}</span>

      {% if produto.estoque|default:0 > 0 %}
        <span class="pill">Em estoque</span>
      {% else %}
        <span class="pill warn">Esgotado</span>
      {% endif %}
    </div>

    {% if vinculo_ong %}
      <div class="pd-hr"></div>
      <div class="kv">
        <span class="tag ok">üíö Produto solid√°rio</span>
        <span class="meta">
          {{ vinculo_ong.percentual }}% vai para
          <a class="accent" href="{% url 'amigofiel:perfil-ong' handle=vinculo_ong.ong.user.username %}">
            {{ vinculo_ong.ong.nome_fantasia }}
          </a>
        </span>
      </div>
    {% endif %}

    <div class="pd-hr"></div>
    {% if produto.tem_desconto %}
      <div class="kv" style="margin-bottom:6px">
        <span class="tag deal">-{{ produto.desconto_percentual|floatformat:0 }}% OFF</span>
      </div>
      <div class="old-price">De R$ {{ produto.preco|floatformat:2 }}</div>
      <div class="price">Por R$ {{ produto.preco_com_desconto|floatformat:2 }}</div>
      <div class="savings">Voc√™ economiza R$ {{ produto.valor_desconto|floatformat:2 }}</div>
    {% else %}
      <div class="price">R$ {{ produto.preco|floatformat:2 }}</div>
    {% endif %}

    <div class="pd-hr"></div>
    <h3 style="margin:0 0 6px;">Descri√ß√£o</h3>
    {% if produto.descricao %}
      <p class="meta" style="white-space:pre-line; margin:0;">
        {{ produto.descricao }}
      </p>
    {% else %}
      <p class="meta" style="margin:0;">Sem descri√ß√£o informada pela loja.</p>
    {% endif %}

    {% if vinculo_ong %}
      <div class="pd-hr"></div>
      <div style="background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border:2px solid #86efac; border-radius:12px; padding:1.5rem; margin:1rem 0;">
        <div style="display:flex; align-items:start; gap:1rem;">
          <div style="font-size:3rem; line-height:1;">üíö</div>
          <div style="flex:1;">
            <h3 style="margin:0 0 0.5rem; color:#166534; font-size:1.25rem;">Produto Solid√°rio</h3>
            <p style="margin:0 0 1rem; color:#166534; line-height:1.6;">
              <strong>{{ vinculo_ong.percentual|floatformat:1 }}%</strong> do valor deste produto ser√° destinado para 
              <strong>{{ vinculo_ong.ong.nome_fantasia }}</strong>, ajudando animais que precisam de cuidados e amor.
            </p>
            <div style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center;">
              <a class="btn" href="{% url 'amigofiel:perfil-ong' handle=vinculo_ong.ong.user.username %}" 
                 style="background:#16a34a; color:#fff; border-color:#16a34a;">
                üêæ Conhecer a ONG
              </a>
              <span style="font-size:0.875rem; color:#15803d;">
                Ao comprar, voc√™ faz a diferen√ßa!
              </span>
            </div>
          </div>
        </div>
        {% if vinculo_ong.percentual > 0 %}
          <div style="margin-top:1rem; padding:0.75rem; background:#fff; border-radius:8px; border:1px solid #bbf7d0;">
            <div style="font-size:0.875rem; color:#166534; margin-bottom:0.25rem;">
              <strong>üí∞ Simula√ß√£o de impacto:</strong>
            </div>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:0.75rem; margin-top:0.5rem;">
              <div>
                <div style="font-size:0.75rem; color:#15803d;">1 unidade</div>
                <div style="font-weight:700; color:#166534;">
                  {% if produto.tem_desconto %}
                    R$ {{ produto.preco_com_desconto|floatformat:2 }}
                  {% else %}
                    R$ {{ produto.preco|floatformat:2 }}
                  {% endif %}
                  √ó {{ vinculo_ong.percentual|floatformat:0 }}% = 
                  {% widthratio produto.preco 100 vinculo_ong.percentual as doacao_valor %}
                  R$ {{ doacao_valor|floatformat:2 }}
                </div>
              </div>
              <div>
                <div style="font-size:0.75rem; color:#15803d;">5 unidades</div>
                <div style="font-weight:700; color:#166534;">
                  {% widthratio produto.preco 100 vinculo_ong.percentual as doacao_valor %}
                  {% widthratio doacao_valor 1 5 as doacao_5x %}
                  R$ {{ doacao_5x|floatformat:2 }} doados
                </div>
              </div>
              <div>
                <div style="font-size:0.75rem; color:#15803d;">10 unidades</div>
                <div style="font-weight:700; color:#166534;">
                  {% widthratio produto.preco 100 vinculo_ong.percentual as doacao_valor %}
                  {% widthratio doacao_valor 1 10 as doacao_10x %}
                  R$ {{ doacao_10x|floatformat:2 }} doados
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}

    <div class="pd-hr"></div>
    <div class="inline-actions">
      <a class="btn" href="{% url 'chat:thread-by-username' username=produto.empresa.user.username %}">
        üí¨ Falar com a loja
      </a>
      <a class="btn" href="{% url 'amigofiel:perfil-empresa' handle=produto.empresa.user.username %}">
        üè™ Ver perfil da loja
      </a>
      {% if vinculo_ong %}
        <a class="btn" href="{% url 'amigofiel:listar-ongs' %}">
          üêæ Ver outras ONGs
        </a>
      {% endif %}
    </div>

    {% if user.is_authenticated and user == produto.empresa.user or user.is_superuser %}
      <div class="pd-hr"></div>
      <div class="inline-actions">
        <a class="btn btn-primary" href="{% url 'amigofiel:produto-editar' produto.empresa.user.username produto.slug %}">
          ‚úèÔ∏è Editar Produto
        </a>
        <a class="btn" href="{% url 'amigofiel:produto-deletar' produto.empresa.user.username produto.slug %}" 
           onclick="return confirm('Tem certeza que deseja desativar este produto?')">
          üóëÔ∏è Desativar
        </a>
      </div>
    {% endif %}
  </section>

  {# ===== COLUNA LATERAL (BUYBOX) ===== #}
  <aside class="pd-card buybox" aria-label="Comprar">
    {% if produto.tem_desconto %}
      <div class="row">
        <span class="muted">De</span>
        <span class="old-price">R$ {{ produto.preco|floatformat:2 }}</span>
      </div>
      <div class="row">
        <span class="muted">Por</span>
        <strong>R$ {{ produto.preco_com_desconto|floatformat:2 }}</strong>
      </div>
      <div class="row">
        <span class="muted">Economia</span>
        <span class="savings">R$ {{ produto.valor_desconto|floatformat:2 }} ({{ produto.desconto_percentual|floatformat:0 }}%)</span>
      </div>
    {% else %}
      <div class="row">
        <span class="muted">Pre√ßo</span>
        <strong>R$ {{ produto.preco|floatformat:2 }}</strong>
      </div>
    {% endif %}
    <div class="row">
      <span class="muted">Disponibilidade</span>
      <strong>
        {% if produto.estoque|default:0 > 0 %}Em estoque{% else %}Esgotado{% endif %}
      </strong>
    </div>

    {% if vinculo_ong %}
      <div class="pd-hr"></div>
      <div style="background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border:2px solid #86efac; border-radius:8px; padding:1rem;">
        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
          <span style="font-size:1.5rem;">üíö</span>
          <strong style="color:#166534;">Produto Solid√°rio</strong>
        </div>
        <div class="row" style="margin:0.25rem 0;">
          <span style="color:#15803d; font-size:0.875rem;">Doa√ß√£o para ONG</span>
          <strong style="color:#166534;">{{ vinculo_ong.percentual|floatformat:1 }}%</strong>
        </div>
        <div class="row" style="margin:0.25rem 0;">
          <span style="color:#15803d; font-size:0.875rem;">Valor por unidade</span>
          <strong style="color:#166534;">
            {% widthratio produto.preco 100 vinculo_ong.percentual as doacao_unitaria %}
            R$ {{ doacao_unitaria|floatformat:2 }}
          </strong>
        </div>
        <p style="margin:0.75rem 0 0; font-size:0.75rem; color:#15803d; line-height:1.4;">
          Sua compra apoia <strong>{{ vinculo_ong.ong.nome_fantasia }}</strong> üêæ
        </p>
        <a href="{% url 'amigofiel:perfil-ong' handle=vinculo_ong.ong.user.username %}" 
           style="display:block; margin-top:0.5rem; text-align:center; padding:0.5rem; background:#16a34a; color:#fff; border-radius:6px; text-decoration:none; font-size:0.875rem; font-weight:600;">
          Ver ONG ‚Üí
        </a>
      </div>
    {% endif %}

    <div class="pd-hr"></div>

    <form method="post" action="{% url 'amigofiel:carrinho-add' produto_id=produto.id %}">
      {% csrf_token %}

      <label class="muted" for="qtd">Quantidade</label>
      <div class="qty" style="margin:6px 0 10px;">
        <button type="button" data-minus aria-label="diminuir">‚àí</button>
        <input id="qtd" name="qtd" type="number" min="1"
               max="{{ produto.estoque|default:99 }}" value="1">
        <button type="button" data-plus aria-label="aumentar">+</button>
      </div>

      <button class="btn-primary btn-lg" type="submit"
              {% if not produto.estoque %}disabled{% endif %}>
        Comprar agora
      </button>
    </form>

    <div style="height:8px"></div>

    <form method="post" action="{% url 'amigofiel:carrinho-add' produto_id=produto.id %}">
      {% csrf_token %}
      <input type="hidden" name="qtd" value="1">
      <button class="btn btn-lg" type="submit" {% if not produto.estoque %}disabled{% endif %}>
        Adicionar √† sacola
      </button>
    </form>
  </aside>

</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const minus = document.querySelector('[data-minus]');
  const plus  = document.querySelector('[data-plus]');
  const input = document.querySelector('#qtd');
  if(!minus || !plus || !input) return;
  minus.addEventListener('click', ()=> {
    const min = parseInt(input.min || '1', 10);
    let v = parseInt(input.value || '1', 10);
    input.value = Math.max(min, v - 1);
  });
  plus.addEventListener('click', ()=> {
    const max = parseInt(input.max || '99', 10);
    let v = parseInt(input.value || '1', 10);
    input.value = Math.min(max, v + 1);
  });
})();
</script>
{% endblock %}
