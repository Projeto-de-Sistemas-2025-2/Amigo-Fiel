{% extends "style/base_public.html" %}
{% load static %}

{% block title %}Produtos ‚Äî Amigo Fiel{% endblock %}

{% block extra_head %}
<style>
  /* Layout de listagem ao estilo marketplace */
  .prod-layout{display:grid;grid-template-columns:280px 1fr;gap:16px}
  @media (max-width:980px){ .prod-layout{grid-template-columns:1fr} }

  .filters .section + .section{margin-top:14px}
  .filters h3{font-size:14px;margin:0 0 6px}
  .filters .input, .filters select{
    width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;
  }
  .filters .check{display:flex;align-items:center;gap:8px;margin:6px 0}
  .filters .actions{display:flex;gap:8px;margin-top:10px}
  .filters .btn{cursor:pointer}

  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  @media (max-width:1200px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:820px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:540px){ .grid{grid-template-columns:1fr} }

  .card{display:flex;flex-direction:column;gap:6px;position:relative}
  .thumb{
    width:100%;aspect-ratio:1/1;border-radius:12px;object-fit:cover;border:1px solid #e5e7eb;background:#fff;
  }
  .title{font-weight:600;margin:2px 0}
  .price{font-weight:700}
  .muted{color:#6b7280}
  .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .pill{
    background: rgb(255, 237, 2);
    color: #0F172A;
    border-radius: 999px;
    padding: 2px 8px;
    font-size: 12px;
  }

  .card .fav-btn{
    position:absolute;
    top:10px;
    right:10px;
    width:40px;
    height:40px;
    padding:0;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    background:#fff;
    border:1px solid #ddd;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    cursor:pointer;
    transition:all 0.2s ease;
    z-index:2;
  }

  .card .fav-btn:hover{
    background:#fff3f3;
    border-color:#ff6b9d;
    transform:translateY(-1px);
  }

  .card .fav-btn.is-favoritado{
    background:#ffe0e6;
    border-color:#ff6b9d;
    box-shadow:0 6px 16px rgba(255,107,157,0.28);
  }

  .card .fav-btn.is-favoritado:hover{
    background:#ffd2dc;
  }

  .card .fav-btn:focus-visible{
    outline:2px solid #ff6b9d;
    outline-offset:2px;
  }

  .pagination{display:flex;justify-content:center;gap:8px;margin:16px 0 4px}
  .pagination a{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;text-decoration:none}
  .pagination .muted{padding:8px 0}
</style>
{% endblock %}

{% block body %}

<div class="prod-layout">

  <!-- Sidebar de filtros -->
  <aside class="filters card" aria-label="Filtros">
    <form method="get">
      <div class="section">
        <h3>Pesquisar</h3>
        <input class="input" type="search" name="q" value="{{ q }}" placeholder="Nome, descri√ß√£o, @empresa">
      </div>

      <div class="section">
        <h3>Cidade</h3>
        <input class="input" type="text" name="cidade" value="{{ cidade }}" placeholder="Ex.: Palmas">
      </div>

      <div class="section">
        <h3>Lojas</h3>
        <select name="loja">
          <option value="">Todas</option>
          {% for loja in lojas %}
            <option value="{{ loja.user.username }}"
                    {% if loja.user.username == loja_sel %}selected{% endif %}>
              {{ loja.razao_social }}
            </option>
          {% empty %}
            {% comment %} fallback sem contexto {% endcomment %}
          {% endfor %}
        </select>
      </div>

<div class="section">
  <h3>Categorias</h3>
  <div style="display:grid;gap:6px">
    {% if categorias %}
      {% for val, label in categorias %}
        <label class="check">
          <input type="checkbox" name="cat" value="{{ val }}"
                 {% if val in cat %}checked{% endif %}>
          <span>{{ label }}</span>
        </label>
      {% endfor %}
    {% else %}
      {# Fallback est√°tico, sem .split() #}
      <label class="check">
        <input type="checkbox" name="cat" value="racao" {% if "racao" in cat %}checked{% endif %}>
        <span>Ra√ß√£o</span>
      </label>
      <label class="check">
        <input type="checkbox" name="cat" value="brinquedos" {% if "brinquedos" in cat %}checked{% endif %}>
        <span>Brinquedos</span>
      </label>
      <label class="check">
        <input type="checkbox" name="cat" value="roupas" {% if "roupas" in cat %}checked{% endif %}>
        <span>Roupas</span>
      </label>
      <label class="check">
        <input type="checkbox" name="cat" value="farmacia" {% if "farmacia" in cat %}checked{% endif %}>
        <span>Farm√°cia</span>
      </label>
      <label class="check">
        <input type="checkbox" name="cat" value="banho" {% if "banho" in cat %}checked{% endif %}>
        <span>Banho &amp; Tosa</span>
      </label>
    {% endif %}
  </div>
</div>


      <div class="section">
        <h3>Pre√ßo (R$)</h3>
        <div class="row" style="gap:8px">
          <input class="input" style="flex:1" type="number" step="0.01" min="0" name="preco_min" value="{{ preco_min }}" placeholder="M√≠n">
          <input class="input" style="flex:1" type="number" step="0.01" min="0" name="preco_max" value="{{ preco_max }}" placeholder="M√°x">
        </div>
        <label class="check" style="margin-top:8px">
          <input type="checkbox" name="com_estoque" value="1" {% if com_estoque %}checked{% endif %}>
          <span>Somente com estoque</span>
        </label>
      </div>

      <div class="actions">
        <button class="btn primary" type="submit">Aplicar</button>
        <a class="btn" href="{% url 'amigofiel:listar-produtos' %}">Limpar</a>
      </div>
    </form>
  </aside>

  <!-- Lista de produtos -->
  <section aria-label="Resultados">
    <header class="row" style="margin-bottom:10px">
      <h2 style="margin:0">Ofertas e Produtos</h2>
      {% if current_city %}<span class="pill">üìç {{ current_city }}</span>{% endif %}
    </header>

    {% if produtos %}
      <div class="grid">
        {% for prod in produtos %}
          {% with handle=prod.empresa.user.username slug=prod.slug %}
          <article class="card">
            {% if user.is_authenticated and user.perfil_comum %}
        <button type="button"
          class="fav-btn favoritar-produto-btn{% if prod.id in favoritos_produto_ids %} is-favoritado{% endif %}"
          data-url="{% url 'amigofiel:favoritar-produto' empresa_handle=handle produto_slug=slug %}"
          data-produto-nome="{{ prod.nome|escape }}"
                      data-favoritado="{% if prod.id in favoritos_produto_ids %}true{% else %}false{% endif %}"
                      aria-pressed="{% if prod.id in favoritos_produto_ids %}true{% else %}false{% endif %}"
                      title="{% if prod.id in favoritos_produto_ids %}Remover dos favoritos{% else %}Adicionar aos favoritos{% endif %}">
                {% if prod.id in favoritos_produto_ids %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
              </button>
            {% endif %}
            <a
              {% if slug %}
                href="{% url 'amigofiel:produto-detalhe' empresa_handle=handle produto_slug=slug %}"
              {% else %}
                href="#"
              {% endif %}
              style="text-decoration:none;color:inherit"
            >
              <img class="thumb"
                   src="{% if prod.imagem %}{{ prod.imagem.url }}{% else %}{% static 'img/defaults/produto.png' %}{% endif %}"
                   alt="{{ prod.nome }}" loading="lazy" decoding="async">
              <div class="title">{{ prod.nome }}</div>
            </a>

            <div class="row">
              <div class="price">R$ {{ prod.preco }}</div>
              <a class="pill" href="{% url 'amigofiel:perfil-empresa' handle=handle %}">{{ prod.empresa.razao_social }}</a>
            </div>
          </article>
          {% endwith %}
        {% endfor %}
      </div>

      {% if is_paginated %}
        <nav class="pagination" aria-label="Pagina√ß√£o">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&cidade={{ cidade|urlencode }}&loja={{ loja_sel|urlencode }}&preco_min={{ preco_min }}&preco_max={{ preco_max }}&com_estoque={{ com_estoque }}{% for c in cat %}&cat={{ c|urlencode }}{% endfor %}">Anterior</a>
          {% endif %}
          <span class="muted">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&cidade={{ cidade|urlencode }}&loja={{ loja_sel|urlencode }}&preco_min={{ preco_min }}&preco_max={{ preco_max }}&com_estoque={{ com_estoque }}{% for c in cat %}&cat={{ c|urlencode }}{% endfor %}">Pr√≥xima</a>
          {% endif %}
        </nav>
      {% endif %}

    {% else %}
      <div class="card"><p class="muted">Nenhum produto encontrado com esses filtros.</p></div>
    {% endif %}
  </section>

</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const getCookie = (name) => {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  };

  const ensureToastStyle = () => {
    if (document.getElementById('favoritos-toast-style')) {
      return;
    }
    const style = document.createElement('style');
    style.id = 'favoritos-toast-style';
    style.textContent = `
      @keyframes favoritoFadeInOut {
        0% { opacity: 0; transform: translate(-50%, -10px); }
        10% { opacity: 1; transform: translate(-50%, 0); }
        90% { opacity: 1; transform: translate(-50%, 0); }
        100% { opacity: 0; transform: translate(-50%, -10px); }
      }
      .favoritos-toast {
        animation: favoritoFadeInOut 3.2s ease-in-out;
      }
    `;
    document.head.appendChild(style);
  };

  const showNotification = (message, type = 'info') => {
    ensureToastStyle();
    const alertClass = type === 'success'
      ? 'alert-success'
      : type === 'error'
        ? 'alert-danger'
        : 'alert-info';

    const toast = document.createElement('div');
    toast.className = `alert ${alertClass} favoritos-toast position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
    toast.style.zIndex = '1055';
    toast.textContent = message;

    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3200);
  };

  const aplicarEstado = (btn, favoritado) => {
    btn.dataset.favoritado = favoritado ? 'true' : 'false';
    btn.textContent = favoritado ? '‚ù§Ô∏è' : 'ü§ç';
    btn.classList.toggle('is-favoritado', favoritado);
    btn.setAttribute('aria-pressed', favoritado ? 'true' : 'false');
    btn.title = favoritado ? 'Remover dos favoritos' : 'Adicionar aos favoritos';
  };

  const csrftoken = getCookie('csrftoken');

  document.querySelectorAll('.favoritar-produto-btn').forEach((btn) => {
    aplicarEstado(btn, btn.dataset.favoritado === 'true');

    btn.addEventListener('click', async (event) => {
      event.preventDefault();
      if (btn.dataset.loading === 'true') {
        return;
      }

      btn.dataset.loading = 'true';

      try {
        const response = await fetch(btn.dataset.url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
          },
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.sucesso) {
          aplicarEstado(btn, data.favoritado);
          const mensagem = data.favoritado
            ? `${btn.dataset.produtoNome} adicionado aos favoritos!`
            : `${btn.dataset.produtoNome} removido dos favoritos!`;
          showNotification(mensagem, data.favoritado ? 'success' : 'info');
        } else {
          showNotification(data.mensagem || 'N√£o foi poss√≠vel atualizar o favorito.', 'error');
        }
      } catch (error) {
        console.error('Erro ao favoritar produto:', error);
        showNotification('Erro ao favoritar produto. Tente novamente.', 'error');
      } finally {
        btn.dataset.loading = 'false';
      }
    });
  });
});
</script>
{% endblock %}
