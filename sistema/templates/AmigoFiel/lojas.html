{% extends "style/base_public.html" %}
{% load static %}

{% block title %}Lojas ‚Äî Amigo Fiel{% endblock %}

{% block extra_head %}
<style>
  .ong-badge-loja {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    color: #166534;
    border-radius: 999px;
    padding: 4px 12px;
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 6px rgba(22, 101, 52, 0.2);
    border: 1px solid #86efac;
    margin-top: 8px;
  }
</style>
{% endblock %}

{% block body %}
<div class="container" style="display:grid;grid-template-columns:260px 1fr;gap:16px;">

  <!-- SIDEBAR / FILTROS -->
  <aside class="card" aria-label="Filtros de lojas" style="position:sticky;top:16px;height:fit-content;">
    <form method="get">
      <h2 class="h4" style="margin:0 0 10px;">Refinar busca</h2>

      <!-- Buscar -->
      <div class="input-wrap">
        <label for="q">Nome / @username</label>
        <input id="q" name="q" class="input" type="text" value="{{ q }}" placeholder="Ex.: PetShop Central">
      </div>

      <!-- Cidade -->
      <div class="input-wrap">
        <label for="cidade">Cidade</label>
        <input id="cidade" name="cidade" class="input" type="text" value="{{ cidade }}" placeholder="Ex.: Palmas">
      </div>

      <!-- Apenas com produtos ativos -->
      <div class="input-wrap" style="display:flex;align-items:center;gap:8px">
        <input id="com_produtos" name="com_produtos" value="1" type="checkbox" {% if com_produtos %}checked{% endif %}>
        <label for="com_produtos" style="margin:0">Somente com produtos ativos</label>
      </div>

      <div class="actions" style="margin-top:10px;display:flex;gap:8px;">
        <button class="btn btn-primary" type="submit">Aplicar filtros</button>
        <a class="btn btn-secondary" href="{% url 'amigofiel:listar-lojas' %}">Limpar</a>
      </div>
    </form>
  </aside>

  <!-- MAIN / RESULTADOS -->
  <main>
    <!-- HERO compacto -->
    <header style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;">
      <div>
        <h1 class="h3" style="margin:0;">Lojas parceiras</h1>
        <p class="muted" style="margin:2px 0 0;">Encontre empresas parceiras e seus produtos para pets.</p>
      </div>
      <span class="muted">
        {% if page_obj %}{{ page_obj.paginator.count }}{% else %}{{ lojas|length }}{% endif %}
        resultado{% if page_obj %}{% if page_obj.paginator.count != 1 %}s{% endif %}{% else %}{% if lojas|length != 1 %}s{% endif %}{% endif %}
      </span>
    </header>

    {% if lojas %}
      <section class="grid-4" aria-label="Resultados" style="align-items:stretch;">
        {% for loja in lojas %}
          {% url 'amigofiel:perfil-empresa' handle=loja.user.username as perfil_url %}
          <article class="mini-card" style="display:flex;flex-direction:column;">
            <a href="{{ perfil_url }}" aria-label="Perfil da {{ loja.razao_social }}" style="display:block;text-decoration:none;color:inherit;">
              {% if loja.foto %}
                <img class="thumb"
                     src="{{ loja.foto.url }}"
                     alt="Logo da {{ loja.razao_social }}"
                     loading="lazy" decoding="async">
              {% else %}
                <img class="thumb"
                     src="{% static 'img/defaults/avatar_empresa.png' %}"
                     alt="Logo da {{ loja.razao_social }}"
                     loading="lazy" decoding="async">
              {% endif %}

              <h3 style="margin:8px 0 4px">{{ loja.razao_social }}</h3>
              <p class="muted" style="margin:0 0 6px">
                {% if loja.cidade %}üèôÔ∏è {{ loja.cidade }}{% else %}‚Äî{% endif %}
              </p>

              <p class="muted" style="margin:0 0 10px">
                üõçÔ∏è {{ loja.qtd_produtos_ativos }} produto{{ loja.qtd_produtos_ativos|pluralize }} ativo{{ loja.qtd_produtos_ativos|pluralize }}
                {% if loja.qtd_produtos and loja.qtd_produtos_ativos != loja.qtd_produtos %}
                  ({{ loja.qtd_produtos }} no total)
                {% endif %}
              </p>

              {% if loja.qtd_produtos_com_ong > 0 %}
                <div class="ong-badge-loja" title="Esta loja possui {{ loja.qtd_produtos_com_ong }} produto{{ loja.qtd_produtos_com_ong|pluralize }} vinculado{{ loja.qtd_produtos_com_ong|pluralize }} a ONGs">
                  üíö Apoia ONGs
                </div>
              {% endif %}
            </a>

            <div class="actions" style="margin-top:auto;">
              <a class="btn btn-primary" href="{{ perfil_url }}">Ver perfil</a>
              {% if loja.user.email %}
                <a class="btn btn-secondary"
                  href="mailto:{{ loja.user.email }}?subject=Contato%20-%20Amigo%20Fiel">
                  Contato
                </a>
              {% endif %}
              {% if loja.cidade %}
                <a class="btn btn-secondary" href="?cidade={{ loja.cidade|urlencode }}">Mais em {{ loja.cidade }}</a>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </section>

      <!-- PAGINA√á√ÉO -->
      {% if is_paginated %}
        <nav class="actions" aria-label="Pagina√ß√£o" style="margin-top:16px">
          {% if page_obj.has_previous %}
            <a class="btn btn-secondary"
               href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&cidade={{ cidade|urlencode }}&com_produtos={{ com_produtos }}">Anterior</a>
          {% endif %}

          <span class="muted">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

          {% if page_obj.has_next %}
            <a class="btn btn-secondary"
               href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&cidade={{ cidade|urlencode }}&com_produtos={{ com_produtos }}">Pr√≥xima</a>
          {% endif %}
        </nav>
      {% endif %}
    {% else %}
      <section class="card center">
        <p class="muted">Nenhuma loja encontrada com esses filtros.</p>
      </section>
    {% endif %}
  </main>
</div>
{% endblock %}
