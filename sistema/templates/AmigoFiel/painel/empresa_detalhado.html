{% extends "style/base_public.html" %}
{% load static %}

{% block title %}Painel Detalhado — {{ perfil.razao_social }}{% endblock %}

{% block body %}
<section class="card">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <div>
      <h1>Painel detalhado — {{ perfil.razao_social }}</h1>
      <p class="muted">Métricas por produto — vendas, receita e estoque</p>
    </div>
    <div class="actions">
      <a class="btn" href="{% url 'amigofiel:painel-empresa' handle=perfil.user.username %}">← Voltar</a>
      <a class="btn btn-primary" href="{% url 'amigofiel:produto-novo' %}" style="margin-left:8px;">➕ Novo produto</a>
    </div>
  </div>

  <div style="margin-top:12px;">
    <div style="display:flex; gap:12px; align-items:center;">
      <div style="background:#dcfce7; padding:8px 12px; border-radius:8px; font-weight:700;">Receita total: R$ {{ total_revenue|floatformat:2 }}</div>
      <div style="background:#f8fafc; padding:8px 12px; border-radius:8px;">Itens vendidos: {{ total_sold }}</div>
    </div>
  </div>

  {# Filtros de produtos #}
  <form method="get" style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <input type="search" name="q" placeholder="Buscar produto..." value="{{ filter_state.q }}" style="padding:8px; border:1px solid #e2e8f0; border-radius:8px;">
    <select name="categoria" style="padding:8px; border:1px solid #e2e8f0; border-radius:8px;">
      <option value="">Todas as categorias</option>
      {% for c, label in filter_state.categorias %}
        <option value="{{ c }}" {% if filter_state.categoria == c %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <select name="ativo" style="padding:8px; border:1px solid #e2e8f0; border-radius:8px;">
      <option value="">Todos</option>
      <option value="1" {% if filter_state.ativo == '1' %}selected{% endif %}>Apenas ativos</option>
      <option value="0" {% if filter_state.ativo == '0' %}selected{% endif %}>Apenas inativos</option>
    </select>
    <select name="sort" style="padding:8px; border:1px solid #e2e8f0; border-radius:8px;">
      <option value="">Ordenar por padrão</option>
      <option value="receita_desc" {% if filter_state.sort == 'receita_desc' %}selected{% endif %}>Receita (maior → menor)</option>
      <option value="vendidos_desc" {% if filter_state.sort == 'vendidos_desc' %}selected{% endif %}>Vendidos (maior → menor)</option>
      <option value="estoque_asc" {% if filter_state.sort == 'estoque_asc' %}selected{% endif %}>Estoque (menor → maior)</option>
      <option value="nome_asc" {% if filter_state.sort == 'nome_asc' %}selected{% endif %}>Nome (A → Z)</option>
    </select>
    <button class="btn btn-primary" type="submit">Filtrar</button>
    <a class="btn" href="{% url 'amigofiel:painel-empresa-detalhado' handle=perfil.user.username %}">Limpar</a>
  </form>

  {# Visão Geral (KPIs + gráfico) - retrátil #}
  <section class="card" style="margin-top:14px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2>Visão Geral</h2>
      <div class="actions">
        <button onclick="toggleKpis()" class="btn-toggle-section" id="btnToggleKpis" type="button">
          <span id="toggleIconKpis">▼</span>
        </button>
      </div>
    </div>

    <div id="kpisContent" class="kpis-content" style="margin-top:12px;">
      {% include 'AmigoFiel/painel/_kpi_cards.html' with chart_id='chartEmpresa' %}
    </div>
  </section>

  <div style="margin-top:16px; overflow:auto;">
    <table class="table" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="text-align:left; background:#f8fafc;">
          <th style="padding:8px; width:56px;"></th>
          <th style="padding:8px;">Produto</th>
          <th style="padding:8px;">Ativo</th>
          <th style="padding:8px;">Preço</th>
          <th style="padding:8px;">Estoque</th>
          <th style="padding:8px;">Vendidos</th>
          <th style="padding:8px;">Receita (R$)</th>
          <th style="padding:8px;">Doação (R$)</th>
          <th style="padding:8px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for row in product_rows %}
          <tr style="border-top:1px solid #eee;">
            <td style="padding:8px; vertical-align:middle;">
              <img src="{% if row.imagem %}{{ row.imagem.url }}{% else %}{% static 'img/defaults/produto.png' %}{% endif %}" alt="{{ row.nome }}" style="width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid #eee;">
            </td>
            <td style="padding:8px; vertical-align:middle;">{{ row.nome }}</td>
            <td style="padding:8px; vertical-align:middle;">
              {% if row.ativo %}
                <span style="color:#16a34a; font-weight:700;">Sim</span>
              {% else %}
                <span style="color:#9ca3af;">Não</span>
              {% endif %}
            </td>
            <td style="padding:8px; vertical-align:middle;">R$ {{ row.preco|floatformat:2 }}</td>
            <td style="padding:8px; vertical-align:middle;">{{ row.estoque }}</td>
            <td style="padding:8px; vertical-align:middle;">{{ row.qtd_vendida }}</td>
            <td style="padding:8px; vertical-align:middle;">{{ row.receita|floatformat:2 }}</td>
            <td style="padding:8px; vertical-align:middle;">{{ row.doacao|floatformat:2 }}</td>
            <td style="padding:8px; vertical-align:middle;">
              {% if row.url_detalhe %}
                <a class="btn btn-primary" href="{{ row.url_detalhe }}">Abrir</a>
              {% endif %}
              {% if row.url_editar %}
                <a class="btn btn-warning" style="margin-left:6px; color:#fff; background:#f59e0b; border-color:#f59e0b;" href="{{ row.url_editar }}">✏️</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
{% block extra_js %}
<style>
  /* KPIs collapsible content (same behaviour used elsewhere) */
  .kpis-content {
    transition: max-height 0.4s ease, opacity 0.3s ease;
    max-height: 5000px;
    opacity: 1;
    overflow: hidden;
    margin-top: 10px;
  }
  .kpis-content.collapsed {
    max-height: 0;
    opacity: 0;
    margin-top: 0 !important;
  }
</style>

<script>
  function toggleKpis() {
    const content = document.getElementById('kpisContent');
    const btn = document.getElementById('btnToggleKpis');
    const icon = document.getElementById('toggleIconKpis');
    
    if (content.classList.contains('collapsed')) {
      // Expandir
      content.classList.remove('collapsed');
      btn.classList.remove('collapsed');
      icon.textContent = '▼';
      localStorage.setItem('kpisExpanded', 'true');
    } else {
      // Retrair
      content.classList.add('collapsed');
      btn.classList.add('collapsed');
      icon.textContent = '▶';
      localStorage.setItem('kpisExpanded', 'false');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const kpisExpanded = localStorage.getItem('kpisExpanded');
    if (kpisExpanded === 'false') {
      const content = document.getElementById('kpisContent');
      const btn = document.getElementById('btnToggleKpis');
      const icon = document.getElementById('toggleIconKpis');
      
      if (content && btn) {
        content.classList.add('collapsed');
        btn.classList.add('collapsed');
        icon.textContent = '▶';
      }
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    try {
      const raw = JSON.parse('{{ chart_data_empresa_json|escapejs }}');
      const labels = raw.labels || [];
      const totals = raw.totals || [];
      const canvas = document.getElementById('chartEmpresa');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Receita semanal (R$)',
              data: totals,
              borderColor: '#16a34a',
              backgroundColor: 'rgba(16,163,127,0.08)',
              tension: 0.25,
              fill: true,
            }]
          },
          options: {
            responsive: true,
            plugins: {legend: {display:false}},
            scales: {y: {beginAtZero:true}}
          }
        });
      }
    } catch(e) { console.error(e); }
  })();
</script>
{% endblock %}
