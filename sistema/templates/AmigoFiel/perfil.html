{% extends "style/base_public.html" %}
{% load static %}

{% block title %}
  {% if tipo == 'usuario' %}@{{ perfil.user.username }}{% elif tipo == 'empresa' %}
    {{ perfil.razao_social }} ‚Äî Perfil
  {% elif tipo == 'ong' %}
    {{ perfil.nome_fantasia }} ‚Äî Perfil
  {% elif tipo == 'pet' %}
    {{ pet.nome }} ‚Äî Pet
  {% else %}Perfil{% endif %}
{% endblock %}

{% block body %}
<div class="container">

  {% if tipo == 'usuario' %}
    <!-- USU√ÅRIO COMUM -->
    <section class="hero">
      <div>
        <h1>@{{ perfil.user.username }}</h1>
        <p class="muted">
          {% if perfil.cidade %}üèôÔ∏è {{ perfil.cidade }}{% endif %}
          {% if perfil.telefone %} ‚Ä¢ ‚òéÔ∏è {{ perfil.telefone }}{% endif %}
        </p>
      </div>
      <div class="only-desktop">
        {% if perfil.foto %}
          <img class="thumb fluid-img" src="{{ perfil.foto.url }}" alt="Foto de {{ perfil.user.username }}" loading="lazy">
        {% endif %}
      </div>
    </section>

    {% if pets %}
      <section class="card">
        <h2>Pets de {{ perfil.user.username }}</h2>
        <div class="grid" style="margin-top:10px">
          {% for p in pets %}
            <article class="mini-card">
              {% if p.imagem %}<img class="thumb" src="{{ p.imagem.url }}" alt="{{ p.nome }}" loading="lazy">{% endif %}
              <h3 style="margin:6px 0 4px">{{ p.nome }}</h3>
              <p class="muted">
                {{ p.get_especie_display }}{% if p.raca %} ‚Ä¢ {{ p.raca }}{% endif %}
                {% if p.idade_anos %} ‚Ä¢ {{ p.idade_anos }} ano{{ p.idade_anos|pluralize }}{% endif %}
              </p>
              <div class="actions">
                <a class="btn btn-primary" href="{% url 'amigofiel:perfil-pet' handle=p.slug %}">Ver pet</a>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>
    {% endif %}

  {% elif tipo == 'empresa' %}
    <!-- EMPRESA -->
    <section class="hero">
      <div>
        <h1>{{ perfil.razao_social }}</h1>
        <p class="muted">
          @{{ perfil.user.username }}
          {% if perfil.cidade %} ‚Ä¢ üèôÔ∏è {{ perfil.cidade }}{% endif %}
          {% if perfil.cnpj %} ‚Ä¢ CNPJ: {{ perfil.cnpj }}{% endif %}
        </p>
      </div>
      <div class="only-desktop">
        {% if perfil.foto %}<img class="thumb fluid-img" src="{{ perfil.foto.url }}" alt="Logo {{ perfil.razao_social }}" loading="lazy">{% endif %}
      </div>
    </section>

    <section class="card">
      <h2>Produtos</h2>
      {% if produtos %}
        <div class="grid" style="margin-top:10px">
          {% for pr in produtos %}
            <article class="mini-card">
              {% if pr.imagem %}<img class="thumb" src="{{ pr.imagem.url }}" alt="{{ pr.nome }}" loading="lazy">{% endif %}
              <h3 style="margin:6px 0 4px">{{ pr.nome }}</h3>
              <p class="muted">{{ pr.descricao|default:"" }}</p>
              <p><strong>R$ {{ pr.preco }}</strong>{% if pr.estoque %} ‚Ä¢ {{ pr.estoque }} un.{% endif %}</p>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">Nenhum produto ativo por enquanto.</p>
      {% endif %}
    </section>

  {% elif tipo == 'ong' %}
    <!-- ONG -->
    <section class="hero">
      <div>
        <h1>{{ perfil.nome_fantasia }}</h1>
        <p class="muted">
          @{{ perfil.user.username }}
          {% if perfil.cidade %} ‚Ä¢ üèôÔ∏è {{ perfil.cidade }}{% endif %}
          {% if perfil.cnpj %} ‚Ä¢ CNPJ: {{ perfil.cnpj }}{% endif %}
          {% if perfil.site %} ‚Ä¢ üåê <a href="{{ perfil.site }}" target="_blank" rel="noopener">Site</a>{% endif %}
        </p>
      </div>
      <div class="only-desktop">
        {% if perfil.foto %}<img class="thumb fluid-img" src="{{ perfil.foto.url }}" alt="Logo {{ perfil.nome_fantasia }}" loading="lazy">{% endif %}
      </div>
    </section>

    {% if pets %}
      <section class="card">
        <h2>Pets da ONG</h2>
        <div class="grid" style="margin-top:10px">
          {% for p in pets %}
            <article class="mini-card">
              {% if p.imagem %}<img class="thumb" src="{{ p.imagem.url }}" alt="{{ p.nome }}" loading="lazy">{% endif %}
              <h3 style="margin:6px 0 4px">{{ p.nome }}</h3>
              <p class="muted">
                {{ p.get_especie_display }}{% if p.raca %} ‚Ä¢ {{ p.raca }}{% endif %}
                {% if p.idade_anos %} ‚Ä¢ {{ p.idade_anos }} ano{{ p.idade_anos|pluralize }}{% endif %}
              </p>
              <div class="actions">
                <a class="btn btn-primary" href="{% url 'amigofiel:perfil-pet' handle=p.slug %}">Ver pet</a>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>
    {% endif %}

  {% elif tipo == 'pet' %}
    <!-- PET -->
    <section class="hero">
      <div>
        <h1>{{ pet.nome }}</h1>
        <p class="muted">
          {{ pet.get_especie_display }}{% if pet.raca %} ‚Ä¢ {{ pet.raca }}{% endif %}
          {% if pet.idade_anos %} ‚Ä¢ {{ pet.idade_anos }} ano{{ pet.idade_anos|pluralize }}{% endif %}
          {% if pet.adotado %} ‚Ä¢ ‚úÖ Adotado{% else %} ‚Ä¢ üíõ Dispon√≠vel{% endif %}
        </p>
      </div>
      <div class="only-desktop">
        {% if pet.imagem %}<img class="thumb fluid-img" src="{{ pet.imagem.url }}" alt="{{ pet.nome }}" loading="lazy">{% endif %}
      </div>
    </section>

    <section class="card">
      <h2>Sobre</h2>
      <p class="muted">{{ pet.descricao|default:"Sem descri√ß√£o." }}</p>

      <div class="actions" style="margin-top:10px">
        {% if pet.tutor %}
          <a class="btn btn-secondary" href="{% url 'amigofiel:perfil-usuario' handle=pet.tutor.user.username %}">
            Tutor: @{{ pet.tutor.user.username }}
          </a>
        {% endif %}
        {% if pet.ong %}
          <a class="btn btn-secondary" href="{% url 'amigofiel:perfil-ong' handle=pet.ong.user.username %}">
            ONG: {{ pet.ong.nome_fantasia }}
          </a>
        {% endif %}
      </div>

      <!-- Bot√£o de Favoritar -->
      {% if user.is_authenticated %}
        {% if user.perfil_comum %}
          <div style="margin-top:15px">
            <button type="button"
                    class="favoritar-btn-detail"
                    data-url="{% url 'amigofiel:favoritar-pet' pet.slug %}"
                    style="background:#fff;border:1px solid #dc3545;color:#dc3545;padding:8px 16px;border-radius:4px;cursor:pointer;transition:all 0.2s;font-weight:500;">
              ü§ç Adicionar aos Favoritos
            </button>
          </div>
        {% endif %}
      {% else %}
        <div style="margin-top:15px">
          <a href="{% url 'django:login' %}" class="btn btn-outline-primary">
            Login para Favoritar
          </a>
        </div>
      {% endif %}
    </section>
  {% endif %}

</div>

<script>
// Sistema de Favoritar com AJAX - P√°gina de Detalhe
const botaoDetail = document.querySelector('.favoritar-btn-detail');
if (botaoDetail) {
  botaoDetail.addEventListener('click', async function(e) {
    e.preventDefault();
    const url = this.dataset.url;
    
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      const data = await response.json();
      
      if (data.sucesso) {
        if (data.favoritado) {
          this.textContent = '‚ù§Ô∏è Remover dos Favoritos';
          this.style.background = '#ffe0e6';
          this.style.borderColor = '#ff6b9d';
          this.style.color = '#ff6b9d';
        } else {
          this.textContent = 'ü§ç Adicionar aos Favoritos';
          this.style.background = '#fff';
          this.style.borderColor = '#dc3545';
          this.style.color = '#dc3545';
        }
        console.log(data.mensagem);
      }
    } catch (error) {
      console.error('Erro ao favoritar:', error);
    }
  });
}

// Fun√ß√£o para obter CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
